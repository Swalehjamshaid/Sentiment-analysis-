{% extends 'base.html' %}
{% block content %}
<div class="row g-3">
  <div class="col-md-3">
    <div class="card"><div class="card-body">
      <h6>Total Reviews</h6><h3 id="totalReviews">0</h3>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card"><div class="card-body">
      <h6>Avg Rating</h6><h3 id="avgRating">0</h3>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card"><div class="card-body">
      <h6>Positive</h6><h3 id="posPct">0%</h3>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card"><div class="card-body">
      <h6>Negative</h6><h3 id="negPct">0%</h3>
    </div></div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card p-2">
      <div class="row g-2">
        <div class="col-md-3"><input type="date" id="startDate" class="form-control"></div>
        <div class="col-md-3"><input type="date" id="endDate" class="form-control"></div>
        <div class="col-md-3">
          <select id="sentiment" class="form-select">
            <option value="">All sentiments</option>
            <option>Positive</option>
            <option>Neutral</option>
            <option>Negative</option>
          </select>
        </div>
        <div class="col-md-2">
          <select id="rating" class="form-select">
            <option value="">All ratings</option>
            <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
          </select>
        </div>
        <div class="col-md-1 d-grid"><button id="applyFilters" class="btn btn-outline-primary">Filter</button></div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-md-8"><div class="card chart-box p-2"><canvas id="trendChart"></canvas></div></div>
  <div class="col-md-4"><div class="card chart-box p-2"><canvas id="keywordsChart"></canvas></div></div>
</div>

<div class="mt-3 d-flex gap-2">
  <a class="btn btn-outline-secondary" id="exportCsv">Export CSV</a>
  <a class="btn btn-outline-secondary" id="exportXlsx">Export Excel</a>
</div>

<script>
const companyId = {{ company_id }};
let trendChart, keywordsChart;

function qs() {
  const s = document.getElementById('startDate').value;
  const e = document.getElementById('endDate').value;
  const sen = document.getElementById('sentiment').value;
  const r = document.getElementById('rating').value;
  const params = new URLSearchParams();
  if (s) params.set('start_date', s);
  if (e) params.set('end_date', e);
  if (sen) params.set('sentiment', sen);
  if (r) params.set('rating', r);
  return params.toString();
}

async function loadSummary() {
  const res = await fetch(`/dashboard/summary/${companyId}?` + qs());
  const data = await res.json();
  document.querySelector('#totalReviews').innerText = data.total_reviews;
  document.querySelector('#avgRating').innerText = data.avg_rating;
  document.querySelector('#posPct').innerText = data.positive_pct + '%';
  document.querySelector('#negPct').innerText = data.negative_pct + '%';
}

async function loadTrend() {
  const res = await fetch(`/dashboard/trend/${companyId}?` + qs());
  const data = await res.json();
  const labels = data.map(x => x.period);
  const values = data.map(x => x.avg_rating);
  if (trendChart) trendChart.destroy();
  trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Avg Rating', data: values, borderColor: '#0d6efd' }] },
    options: { responsive: true, scales: { y: { min: 0, max: 5 } } }
  });
}

async function loadKeywords() {
  const res = await fetch(`/dashboard/keywords/${companyId}?` + qs());
  const data = await res.json();
  const labels = data.map(x => x.keyword);
  const values = data.map(x => x.count);
  if (keywordsChart) keywordsChart.destroy();
  keywordsChart = new Chart(document.getElementById('keywordsChart'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Keyword Count', data: values, backgroundColor: '#198754' }] },
    options: { responsive: true }
  });
}

async function refreshAll(){
  await loadSummary();
  await loadTrend();
  await loadKeywords();
}
document.getElementById('applyFilters')?.addEventListener('click', refreshAll);

document.getElementById('exportCsv')?.addEventListener('click', ()=>{
  window.location.href = `/dashboard/export/${companyId}?fmt=csv`;
});
document.getElementById('exportXlsx')?.addEventListener('click', ()=>{
  window.location.href = `/dashboard/export/${companyId}?fmt=xlsx`;
});

refreshAll();
</script>
{% endblock %}
