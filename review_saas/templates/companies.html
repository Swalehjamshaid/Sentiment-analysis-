{% extends "base.html" %}

{% block title %}Companies Â· Reputation SaaS{% endblock %}

{% block content %}
<div class="row g-4">
  <!-- Add Company Form -->
  <div class="col-12 col-lg-5">
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body p-4">
        <h5 class="card-title mb-4 text-primary fw-bold">Add Company</h5>

        <form action="/api/companies" method="post" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="company_name" class="form-label fw-semibold">Company Name</label>
            <input
              id="company_name"
              name="name"
              type="text"
              class="form-control form-control-lg rounded-pill"
              placeholder="Search business (Google Places)"
              autocomplete="off"
              required
            />
            <div class="form-text text-muted">Start typing and select a place from the suggestions.</div>
          </div>

          <div class="mb-3">
            <label for="city" class="form-label fw-semibold">City</label>
            <input
              id="city"
              name="city"
              type="text"
              class="form-control form-control-lg rounded-pill"
              placeholder="City"
              autocomplete="off"
              required
            />
          </div>

          <!-- Hidden fields populated by JS -->
          <input type="hidden" id="place_id" name="place_id" />

          <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill mt-3">
            <i class="bi bi-plus-lg me-2"></i>Add Company
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Search / Filter Table -->
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body p-4">
        <h5 class="card-title mb-3 text-primary fw-bold">Search / Filter</h5>

        <div class="table-responsive mt-4">
          <table class="table table-hover table-bordered align-middle">
            <thead class="table-light text-uppercase text-secondary small">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Place ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Render your rows here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function initPlacesAutocomplete() {
  function mapsReady() {
    return window.google && google.maps && google.maps.places;
  }

  function extractCity(addressComponents) {
    if (!addressComponents) return "";
    const pick = (type) =>
      addressComponents.find(c => c.types.includes(type))?.long_name || "";
    return pick("locality") || pick("administrative_area_level_2") || pick("administrative_area_level_1") || "";
  }

  function attachAutocomplete() {
    const nameEl = document.getElementById("company_name");
    const cityEl = document.getElementById("city");
    const pidEl  = document.getElementById("place_id");
    if (!nameEl) return;

    const ac = new google.maps.places.Autocomplete(nameEl, {
      types: ["establishment"],
      componentRestrictions: { country: "pk" },
      fields: ["name", "place_id", "address_components", "formatted_address"],
    });

    ac.addListener("place_changed", function () {
      const place = ac.getPlace();
      if (!place) return;

      if (place.name) nameEl.value = place.name;

      const city = extractCity(place.address_components);
      if (city && cityEl) cityEl.value = city;

      if (pidEl && place.place_id) {
        pidEl.value = place.place_id;
      }
    });
  }

  (function waitForMaps(attempt = 0) {
    if (mapsReady()) attachAutocomplete();
    else if (attempt < 60) setTimeout(() => waitForMaps(attempt + 1), 100);
    else console.error("Google Maps JS failed to load.");
  })();
})();
</script>
{% endblock %}
