{% extends "base.html" %}

{% block title %}Companies Â· Reputation SaaS{% endblock %}

{% block content %}
<div class="row g-3">
  <div class="col-12 col-lg-5">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">Add Company</h5>

        <!-- Adjust the action/method to match your API -->
        <form action="/api/companies" method="post" class="needs-validation" novalidate>
          <div class="mb-3">
            <label for="company_name" class="form-label">Company Name</label>
            <input
              id="company_name"
              name="name"
              type="text"
              class="form-control"
              placeholder="Search business (Google Places)"
              autocomplete="off"
              required
            />
            <div class="form-text">Start typing and select a place from the dropdown.</div>
          </div>

          <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input
              id="city"
              name="city"
              type="text"
              class="form-control"
              placeholder="City"
              autocomplete="off"
              required
            />
          </div>

          <!-- Optional: persist the selected Google Place ID -->
          <input type="hidden" id="place_id" name="place_id" />

          <button type="submit" class="btn btn-primary">Add Company</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">Search / Filter</h5>

        <form class="row g-2 align-items-end">
          <div class="col-12 col-sm-6 col-lg-3">
            <label class="form-label" for="filter_name">Name</label>
            <input id="filter_name" class="form-control" type="text" />
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <label class="form-label" for="filter_city">City</label>
            <input id="filter_city" class="form-control" type="text" />
          </div>
          <div class="col-12 col-sm-6 col-lg-2">
            <label class="form-label" for="filter_status">Status</label>
            <select id="filter_status" class="form-select">
              <option value="">Any</option>
              <option value="active">Active</option>
              <option value="paused">Paused</option>
            </select>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <label class="form-label" for="filter_pid">Place ID</label>
            <input id="filter_pid" class="form-control" type="text" />
          </div>
          <div class="col-12 col-lg-1">
            <button type="button" class="btn btn-outline-primary w-100">Apply</button>
          </div>
          <div class="col-12 col-lg-1">
            <button type="button" class="btn btn-outline-secondary w-100">Refresh</button>
          </div>
        </form>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Place ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Render your companies here -->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function initPlacesAutocomplete() {
    // Ensure the async/defer Google Maps JS is ready
    function mapsReady() {
      return window.google && google.maps && google.maps.places;
    }

    // Best-effort city extraction for PK (fallbacks to admin levels)
    function extractCity(addressComponents) {
      if (!addressComponents) return "";
      const pick = (type) =>
        addressComponents.find((c) => c.types.includes(type))?.long_name || "";
      return (
        pick("locality") ||
        pick("administrative_area_level_2") ||
        pick("administrative_area_level_1") ||
        ""
      );
    }

    function attachAutocomplete() {
      const nameEl = document.getElementById("company_name");
      const cityEl = document.getElementById("city");
      const pidEl  = document.getElementById("place_id");
      if (!nameEl) return;

      const ac = new google.maps.places.Autocomplete(nameEl, {
        types: ["establishment"],                  // businesses/places
        componentRestrictions: { country: "pk" },  // adjust if needed
        fields: ["name", "place_id", "address_components", "formatted_address"],
      });

      ac.addListener("place_changed", function () {
        const place = ac.getPlace();
        if (!place) return;

        if (place.name) nameEl.value = place.name;

        const city = extractCity(place.address_components);
        if (city && cityEl) cityEl.value = city;

        if (pidEl && place.place_id) pidEl.value = place.place_id;
      });
    }

    (function waitForMaps(attempt = 0) {
      if (mapsReady()) {
        attachAutocomplete();
      } else if (attempt < 60) {
        setTimeout(() => waitForMaps(attempt + 1), 100);
      } else {
        console.error(
          "Google Maps JS failed to load. Check key injection, APIs enabled, billing, and HTTP referrer restrictions."
        );
      }
    })();
  })();
</script>
{% endblock %}
