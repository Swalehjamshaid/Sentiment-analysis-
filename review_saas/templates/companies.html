{% extends "base.html" %}

{% block title %}Companies · Reputation SaaS{% endblock %}

{% block content %}

<!-- =======================
     Header / Hero
======================== -->
<section class="hero mb-4">
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <h1 class="h3 fw-bold mb-1 brand-gradient">
        <i class="bi bi-buildings me-2"></i> Manage Companies
      </h1>
      <div class="text-muted small">Add companies with Google Places, auto-fill city, and monitor status.</div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <a href="/home" class="btn btn-sm btn-outline-secondary"><i class="bi bi-house-door"></i> Home</a>
      <a href="/ui/companies" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-repeat"></i> Refresh</a>
    </div>
  </div>
</section>

<div class="row g-4">
  <!-- =========================================
       Left: Add Company (Glass Card)
  ========================================== -->
  <div class="col-12 col-lg-5">
    <div class="glass-card p-3 p-md-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h5 fw-semibold mb-0"><i class="bi bi-plus-circle me-2"></i>Add Company</h2>
        <span class="badge text-bg-primary-subtle border border-primary-subtle"><i class="bi bi-google me-1"></i>Places</span>
      </div>
      <p class="text-muted small mb-3">Start typing a business name and pick from suggestions. City fills automatically.</p>

      <form id="companyForm" action="/api/companies" method="post" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="company_name" class="form-label">Company Name</label>
          <input
            id="company_name"
            name="name"
            type="text"
            class="form-control form-control-lg"
            placeholder="e.g., Gloria Jeans Gulberg"
            autocomplete="off"
            required
          />
          <div class="form-text">Powered by Google Places Autocomplete.</div>
          <div class="invalid-feedback">Please enter a company name.</div>
        </div>

        <div class="mb-3">
          <label for="city" class="form-label">City</label>
          <input
            id="city"
            name="city"
            type="text"
            class="form-control"
            placeholder="Auto-filled city"
            autocomplete="off"
            required
          />
          <div class="invalid-feedback">City is required.</div>
        </div>

        <!-- Optional visible extras -->
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="status" class="form-label">Status</label>
            <select id="status" name="status_value" class="form-select">
              <option value="Active" selected>Active</option>
              <option value="Paused">Paused</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label for="logo_url" class="form-label">Logo URL (optional)</label>
            <input id="logo_url" name="logo_url" type="url" class="form-control" placeholder="https://..." />
          </div>
        </div>

        <!-- Hidden fields (populated by JS) -->
        <input type="hidden" id="place_id" name="place_id" />
        <input type="hidden" id="maps_url" name="maps_url" />
        <!-- If you later want to bind to a user: -->
        <!-- <input type="hidden" id="owner_user_id" name="owner_user_id" value=""> -->

        <div class="d-flex align-items-center gap-2 mt-4">
          <button id="btnSubmit" type="submit" class="btn btn-primary px-4">
            <i class="bi bi-cloud-arrow-up"></i> Save
          </button>
          <button id="btnReset" type="reset" class="btn btn-outline-secondary">
            <i class="bi bi-eraser"></i> Reset
          </button>
          <a id="mapsPreview" href="#" target="_blank" class="btn btn-outline-info d-none">
            <i class="bi bi-geo-alt"></i> Google Maps
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- =========================================
       Right: Status Chart + Companies Table
  ========================================== -->
  <div class="col-12 col-lg-7">
    <div class="glass-card p-3 p-md-4 mb-4">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h6 fw-semibold mb-0"><i class="bi bi-pie-chart me-2"></i>Status Overview</h2>
        <div class="text-muted small" id="summaryText">Loading…</div>
      </div>
      <canvas id="statusChart" height="120" class="mt-3"></canvas>
    </div>

    <div class="glass-card p-3 p-md-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h6 fw-semibold mb-0"><i class="bi bi-table me-2"></i>Companies</h2>
        <div class="input-group input-group-sm" style="max-width: 260px;">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="searchBox" type="search" class="form-control" placeholder="Search name or city" />
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="companiesTable">
          <thead class="table-light">
            <tr>
              <th style="width: 60px;">ID</th>
              <th>Name</th>
              <th>City</th>
              <th class="d-none d-md-table-cell">Place ID</th>
              <th>Status</th>
              <th class="text-end" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody id="companiesTbody">
            <!-- populated by JS -->
          </tbody>
        </table>
      </div>
      <div id="emptyState" class="text-center text-muted small py-4 d-none">
        <i class="bi bi-inboxes fs-3 d-block mb-2"></i>
        No companies found. Add your first company on the left.
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // -------------------------------
  // Google Places Autocomplete
  // -------------------------------
  (function initPlacesAutocomplete() {
    function mapsReady() { return window.google && google.maps && google.maps.places; }

    function extractCity(components) {
      if (!components) return "";
      const pick = (t) => components.find(c => c.types.includes(t))?.long_name || "";
      return pick("locality") || pick("administrative_area_level_2") || pick("administrative_area_level_1") || "";
    }

    function attach() {
      const nameEl = document.getElementById("company_name");
      const cityEl = document.getElementById("city");
      const pidEl  = document.getElementById("place_id");
      const mapsEl = document.getElementById("maps_url");
      const previewBtn = document.getElementById("mapsPreview");

      if (!nameEl) return;

      const ac = new google.maps.places.Autocomplete(nameEl, {
        types: ["establishment"],
        componentRestrictions: { country: "pk" }, // adjust if needed
        fields: ["name", "place_id", "address_components"],
      });

      ac.addListener("place_changed", () => {
        const place = ac.getPlace();
        if (!place) return;

        // keep input in sync
        if (place.name) nameEl.value = place.name;

        // city
        const city = extractCity(place.address_components);
        if (city && cityEl) cityEl.value = city;

        // place id & maps url
        if (pidEl && place.place_id) {
          pidEl.value = place.place_id;
          const url = `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;
          if (mapsEl) mapsEl.value = url;
          if (previewBtn) {
            previewBtn.classList.remove("d-none");
            previewBtn.href = url;
          }
        }
      });
    }

    (function wait(i=0){
      if (mapsReady()) return attach();
      if (i < 80) return setTimeout(() => wait(i+1), 100);
      console.error("Google Maps JS failed to load.");
    })();
  })();

  // -------------------------------
  // Client-side Validation + Submit
  // -------------------------------
  (function handleCompanyForm() {
    const form = document.getElementById("companyForm");
    const btnSubmit = document.getElementById("btnSubmit");

    async function submitForm(e) {
      e.preventDefault();
      e.stopPropagation();

      // Bootstrap validation UI
      form.classList.add('was-validated');
      if (!form.checkValidity()) {
        showToast('Validation', 'Please fix form errors and try again.', 'warning');
        return;
      }

      btnSubmit.disabled = true;
      btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving…';

      try {
        const fd = new FormData(form);
        const res = await fetch(form.action, {
          method: 'POST',
          body: fd
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data?.detail || `Request failed (${res.status})`;
          showToast('Error', msg, 'danger');
        } else {
          const data = await res.json();
          showToast('Saved', `Company “${data?.company?.name || ''}” created successfully.`, 'success');
          form.reset();
          document.getElementById("mapsPreview")?.classList.add("d-none");
          // reload list
          await loadCompanies();
        }
      } catch (err) {
        console.error(err);
        showToast('Network', 'Could not reach server. Please try again.', 'danger');
      } finally {
        btnSubmit.disabled = false;
        btnSubmit.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Save';
        form.classList.remove('was-validated');
      }
    }

    form?.addEventListener('submit', submitForm);
  })();

  // -------------------------------
  // Companies Table + Chart
  // -------------------------------
  let statusChart;

  async function loadCompanies() {
    const tbody = document.getElementById('companiesTbody');
    const empty = document.getElementById('emptyState');
    const searchBox = document.getElementById('searchBox');
    const summaryText = document.getElementById('summaryText');

    tbody.innerHTML = `
      <tr><td colspan="6" class="text-center py-4">
        <div class="spinner-border spinner-border-sm me-2"></div> Loading...
      </td></tr>`;

    try {
      const res = await fetch('/api/companies');
      const data = await res.json();

      // Filter on the fly
      const q = (searchBox?.value || '').trim().toLowerCase();
      const rows = (Array.isArray(data) ? data : []).filter(r => {
        if (!q) return true;
        return (r.name || '').toLowerCase().includes(q) || (r.city || '').toLowerCase().includes(q);
      });

      // Render
      if (rows.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('d-none');
      } else {
        empty.classList.add('d-none');
        tbody.innerHTML = rows.map(r => {
          const pidShort = (r.place_id || '').slice(0, 6) + (r.place_id ? '…' : '');
          const statusBadge = (r.status || 'Active') === 'Active'
            ? '<span class="badge text-bg-success-subtle border border-success-subtle">Active</span>'
            : '<span class="badge text-bg-secondary-subtle border border-secondary-subtle">Paused</span>';
          const mapHref = r.place_id ? `https://www.google.com/maps/place/?q=place_id:${r.place_id}` : '#';

          return `
            <tr>
              <td class="text-muted">${r.id ?? ''}</td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  ${r.logo_url ? `<img src="${r.logo_url}" alt="" width="28" height="28" class="rounded-circle border">` : '<i class="bi bi-shop text-muted"></i>'}
                  <div>
                    <div class="fw-semibold">${r.name ?? ''}</div>
                    <div class="small text-muted">${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</div>
                  </div>
                </div>
              </td>
              <td>${r.city ?? ''}</td>
              <td class="d-none d-md-table-cell">
                ${r.place_id ? `<a class="text-decoration-none" href="${mapHref}" target="_blank" title="${r.place_id}">${pidShort}</a>` : '<span class="text-muted">—</span>'}
              </td>
              <td>${statusBadge}</td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <a class="btn btn-outline-primary" href="${mapHref}" target="_blank" title="Open on Google Maps"><i class="bi bi-geo-alt"></i></a>
                  <button class="btn btn-outline-secondary" title="Edit" disabled><i class="bi bi-pencil-square"></i></button>
                  <button class="btn btn-outline-danger" title="Delete" disabled><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Chart
      const activeCount = rows.filter(r => (r.status || 'Active') === 'Active').length;
      const pausedCount = rows.length - activeCount;
      summaryText.textContent = `${rows.length} total — ${activeCount} active, ${pausedCount} paused`;

      const ctx = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();
      statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Active', 'Paused'],
          datasets: [{
            data: [activeCount, pausedCount],
            backgroundColor: ['#22c55e', '#64748b'],
            hoverBackgroundColor: ['#16a34a', '#475569'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          cutout: '62%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { usePointStyle: true, pointStyle: 'circle' }
            },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${ctx.raw}`
              }
            }
          }
        }
      });

    } catch (err) {
      console.error(err);
      document.getElementById('companiesTbody').innerHTML = `
        <tr><td colspan="6" class="text-center text-danger py-4">
          <i class="bi bi-exclamation-triangle me-1"></i> Failed to load companies.
        </td></tr>`;
    }
  }

  document.getElementById('searchBox')?.addEventListener('input', () => loadCompanies());
  // Initial load
  loadCompanies();
</script>
{% endblock %}
