# Filename: review_saas/app/routes/companies.py

from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from app.db import get_db
from app.models import Company
from typing import List
import requests
from datetime import datetime
from app.core.config import settings

router = APIRouter()

GOOGLE_API_KEY = settings.GOOGLE_API_KEY  # set in config.py or environment variable

@router.get("/companies", response_model=List[dict])
def get_companies(db: Session = Depends(get_db)):
    companies = db.query(Company).all()
    return [{"name": c.name, "city": c.city, "status": c.status} for c in companies]

@router.post("/companies")
def add_company(
    name: str = Query(...),
    city: str = Query(None),
    place_id: str = Query(None),
    db: Session = Depends(get_db)
):
    if place_id:
        # Fetch place details from Google Places API
        url = f"https://maps.googleapis.com/maps/api/place/details/json?place_id={place_id}&key={GOOGLE_API_KEY}"
        resp = requests.get(url)
        if resp.status_code == 200:
            data = resp.json().get("result", {})
            name = data.get("name", name)
            # Extract city from address components
            if "address_components" in data:
                for comp in data["address_components"]:
                    if "locality" in comp.get("types", []):
                        city = comp.get("long_name")
                        break

    new_company = Company(
        name=name,
        city=city,
        status="active",
        created_at=datetime.utcnow(),
        place_id=place_id
    )
    db.add(new_company)
    db.commit()
    db.refresh(new_company)
    return {"name": new_company.name, "city": new_company.city, "status": new_company.status}
