{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Dashboard</h3>
    <div class="d-flex align-items-center gap-3">
      <select id="company-selector" class="form-select w-auto">
        <option value="0">Select a Company...</option>
        <!-- Filled dynamically -->
      </select>
      <button id="refresh-btn" class="btn btn-outline-success">
        <i class="bi bi-arrow-repeat"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Company Overview Card -->
  <div class="card shadow-sm mb-4" id="company-overview" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 id="company-name">Company Name</h4>
          <div class="text-muted">
            Google Rating: <span id="google-rating">—</span> • 
            Total Ratings: <span id="google-total-ratings">—</span>
          </div>
        </div>
        <div class="text-end">
          <small class="text-muted">Last updated: <span id="last-updated">—</span></small>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4 text-center" id="kpi-section">
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h6 class="text-muted">Total Reviews</h6>
          <h3 id="total-reviews">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h6 class="text-muted">Average Rating</h6>
          <h3 id="avg-rating">0.0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h6 class="text-muted">Sentiment Mix</h6>
          <h5 id="sentiment-mix">0 / 0 / 0</h5>
          <small class="text-success">Positive</small> /
          <small class="text-warning">Neutral</small> /
          <small class="text-danger">Negative</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Chart -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title">Rating Trend Over Time</h5>
          <canvas id="trendChart" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-body">
          <h5>Quick Actions</h5>
          <a href="/companies" class="btn btn-outline-primary w-100 mb-2">
            Manage Companies
          </a>
          <a href="/reports" class="btn btn-outline-info w-100 mb-2">
            Generate Report
          </a>
        </div>
      </div>

      <div class="card shadow-sm border-0 mb-3">
        <div class="card-body">
          <h6>Top Keywords</h6>
          <ul id="keywords-list" class="list-group list-group-flush small">
            <li class="list-group-item text-muted">No keywords yet</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Summary Section -->
  <div class="card shadow-sm mb-4" id="ai-summary-card" style="display: none;">
    <div class="card-body">
      <h5>Customer Sentiment Summary</h5>
      <p id="ai-summary" class="text-muted">
        Loading summary...
      </p>
    </div>
  </div>

  <!-- Recent Reviews -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Recent Reviews</h5>
      <div id="reviews-container" class="list-group">
        <div class="list-group-item text-center text-muted py-4">
          No reviews loaded yet. Select a company or refresh.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let ratingChart = null;
  let currentCompanyId = {{ current_company_id | default(0) }};

  async function loadCompanies() {
    try {
      const res = await fetch('/reviews/my-companies');
      if (!res.ok) throw new Error('Failed to load companies');
      const companies = await res.json();

      const select = document.getElementById('company-selector');
      select.innerHTML = '<option value="0">Select a Company...</option>';

      companies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        if (c.id == currentCompanyId) opt.selected = true;
        select.appendChild(opt);
      });

      // Auto-load first company if none selected
      if (currentCompanyId == 0 && companies.length > 0) {
        currentCompanyId = companies[0].id;
        select.value = currentCompanyId;
      }

      if (currentCompanyId > 0) {
        await loadDashboard(currentCompanyId);
      }

      select.addEventListener('change', async (e) => {
        currentCompanyId = parseInt(e.target.value);
        if (currentCompanyId > 0) {
          await loadDashboard(currentCompanyId);
        } else {
          clearDashboard();
        }
      });

    } catch (err) {
      console.error(err);
      document.getElementById('reviews-container').innerHTML =
        '<div class="alert alert-danger">Failed to load companies. Please try again.</div>';
    }
  }

  async function loadDashboard(companyId) {
    if (!companyId) return clearDashboard();

    try {
      const res = await fetch(`/reviews/summary/${companyId}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      // Show overview card
      document.getElementById('company-overview').style.display = 'block';
      document.getElementById('company-name').textContent = data.company_name || 'Company';
      document.getElementById('google-rating').textContent = data.google_rating || '—';
      document.getElementById('google-total-ratings').textContent = data.google_total_ratings || '—';
      document.getElementById('last-updated').textContent = new Date().toLocaleString();

      // KPIs
      document.getElementById('total-reviews').textContent = data.total_reviews;
      document.getElementById('avg-rating').textContent = data.avg_rating.toFixed(1);

      const mix = `${data.sentiments.Positive} / ${data.sentiments.Neutral} / ${data.sentiments.Negative}`;
      document.getElementById('sentiment-mix').textContent = mix;

      // Keywords
      const kwList = document.getElementById('keywords-list');
      kwList.innerHTML = '';
      const allKw = [...data.positive_keywords, ...data.negative_keywords];
      if (allKw.length === 0) {
        kwList.innerHTML = '<li class="list-group-item text-muted">No keywords yet</li>';
      } else {
        allKw.forEach(kw => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = kw;
          kwList.appendChild(li);
        });
      }

      // Recent Reviews
      const container = document.getElementById('reviews-container');
      container.innerHTML = '';
      if (data.reviews.length === 0) {
        container.innerHTML = '<div class="list-group-item text-center text-muted py-4">No reviews yet for this company</div>';
      } else {
        data.reviews.slice(0, 8).forEach(r => {
          const item = document.createElement('div');
          item.className = 'list-group-item';
          item.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">${r.reviewer_name}</h6>
              <small>${r.review_date || 'N/A'}</small>
            </div>
            <p class="mb-1">${r.review_text.substring(0, 140)}${r.review_text.length > 140 ? '...' : ''}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small>Rating: ${r.rating} ★</small>
              <span class="badge ${
                r.sentiment === 'Positive' ? 'bg-success' :
                r.sentiment === 'Negative' ? 'bg-danger' : 'bg-warning'
              }">${r.sentiment}</span>
            </div>
          `;
          container.appendChild(item);
        });
      }

      // Trend Chart
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (ratingChart) ratingChart.destroy();

      let labels = data.trend_data?.map(t => t.month) || [];
      let avgRatings = data.trend_data?.map(t => t.avg_rating) || [];

      if (labels.length === 0 && data.reviews.length > 0) {
        labels = data.reviews.map(r => r.review_date ? new Date(r.review_date).toLocaleDateString() : 'N/A');
        avgRatings = data.reviews.map(r => r.rating);
      }

      ratingChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['No data'],
          datasets: [{
            label: 'Average Rating',
            data: avgRatings.length > 0 ? avgRatings : [0],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.12)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { min: 0, max: 5.5, title: { display: true, text: 'Rating (★)' } },
            x: { title: { display: true, text: 'Time' } }
          }
        }
      });

    } catch (err) {
      console.error(err);
      document.getElementById('reviews-container').innerHTML =
        '<div class="alert alert-warning">Failed to load data. Please try again.</div>';
    }
  }

  function clearDashboard() {
    document.getElementById('company-overview').style.display = 'none';
    document.getElementById('total-reviews').textContent = '0';
    document.getElementById('avg-rating').textContent = '0.0';
    document.getElementById('sentiment-mix').textContent = '0 / 0 / 0';
    document.getElementById('keywords-list').innerHTML = '<li class="list-group-item text-muted">Select a company</li>';
    document.getElementById('reviews-container').innerHTML =
      '<div class="list-group-item text-center text-muted py-4">Select a company to view reviews</div>';
    if (ratingChart) ratingChart.destroy();
  }

  // Load everything on page ready
  document.addEventListener('DOMContentLoaded', async () => {
    await loadCompanies();
  });

  // Refresh button
  document.getElementById('refresh-btn')?.addEventListener('click', async () => {
    if (currentCompanyId > 0) {
      await loadDashboard(currentCompanyId);
    }
  });
</script>
{% endblock %}
