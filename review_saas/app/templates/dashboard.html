<!-- FILE: review_saas/app/templates/dashboard.html -->
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <title>Review Intelligence Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --card-radius: 14px; --shadow-soft: 0 2px 12px rgba(0,0,0,0.05); }
    body { background:#f4f6f9; }
    .card { border:none; border-radius:var(--card-radius); box-shadow:var(--shadow-soft); }
    .metric { font-size:28px; font-weight:700; }
    .badge-risk-low { background:#28a745; }
    .badge-risk-medium { background:#ffc107; color:#000; }
    .badge-risk-high { background:#dc3545; }
    .navbar-brand { font-weight:600; }
    .skeleton { background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.12), rgba(0,0,0,.06)); background-size:200% 100%; animation: shimmer 1.2s infinite; border-radius:8px; min-height: 18px; }
    @keyframes shimmer { 0%{background-position:200% 0;} 100%{background-position:-200% 0;} }
    .chart-wrap { position: relative; min-height: 280px; }
    .date-inputs .form-control[type="date"] { min-width: 160px; }
    .attr-label { width: 160px; color:#6c757d; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; display:inline-block; vertical-align:bottom; }
  </style>
</head>

<body>
<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand">Review Intelligence Dashboard</span>
    <div class="d-flex gap-2">
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
        + Add Company
      </button>
    </div>
  </div>
</nav>

<div class="container">

  <!-- Company Picker + Date Range + Actions -->
  <div class="card p-3 mb-4">
    <div class="row g-3 align-items-end">
      <div class="col-lg-4 col-md-6">
        <label class="form-label">Select Company</label>
        <select id="companySelect" class="form-select" aria-label="Select company"></select>
      </div>
      <div class="col-lg-5 col-md-6 date-inputs">
        <div class="row g-2">
          <div class="col-sm-6">
            <label class="form-label">Start Date</label>
            <input type="date" id="startDate" class="form-control">
          </div>
          <div class="col-sm-6">
            <label class="form-label">End Date</label>
            <input type="date" id="endDate" class="form-control">
          </div>
        </div>
      </div>
      <div class="col-lg-3 text-end">
        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-outline-primary" onclick="applyDateRange()">Apply Range</button>
          <button id="btnGoogleDetails" class="btn btn-secondary" onclick="fetchGoogleDetails()">Fetch Google Details</button>
          <button id="btnSync" class="btn btn-primary" onclick="syncReviews()">
            <span class="sync-label">Sync</span>
            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
        <small id="activeWindowNote" class="text-muted mt-2 d-block"></small>
      </div>
    </div>
  </div>

  <!-- Company Attributes (from Google) -->
  <div class="card p-3 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0">Company Attributes (Google)</h6>
      <small id="attrsStatus" class="text-muted"></small>
    </div>
    <div id="companyAttrs" class="mt-3">
      <div class="text-muted">Click <strong>Fetch Google Details</strong> to load attributes for the selected company.</div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="row mb-4 g-3">
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Total Reviews</div>
        <div id="metricTotal" class="metric skeleton" aria-live="polite"> </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Average Rating</div>
        <div id="metricAvg" class="metric skeleton" aria-live="polite"> </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Risk Score</div>
        <div id="metricRisk" class="metric skeleton" aria-live="polite"> </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Risk Level</div>
        <span id="riskBadge" class="badge badge-risk-low">Low</span>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row mb-4 g-3">
    <div class="col-md-6">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Trend</h6>
          <small id="trendHint" class="text-muted"></small>
        </div>
        <div class="chart-wrap mt-2">
          <canvas id="trendChart" aria-label="Average rating trend"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Sentiment</h6>
        <div class="chart-wrap mt-2">
          <canvas id="sentimentChart" aria-label="Sentiment breakdown"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Recommendations -->
  <div class="card p-3 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h6 class="mb-0">AI Action Recommendations</h6>
      <button class="btn btn-sm btn-outline-dark" onclick="openOwnerSummary()">AI Owner Summary</button>
    </div>
    <div id="recommendations" class="mt-2"></div>
  </div>
</div>

<!-- Add Company Modal -->
<div class="modal fade" id="addCompanyModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Add New Company</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="mb-2">
          <label class="form-label">Business Name (Google)</label>
          <div class="input-group">
            <input type="text" id="placeQuery" class="form-control" placeholder="e.g., Gloria Jeans Lahore">
            <button class="btn btn-outline-secondary" onclick="searchPlace()">Search</button>
          </div>
          <div id="searchResults" class="mt-2"></div>
        </div>

        <hr>

        <div class="mb-2">
          <label class="form-label">Company Name</label>
          <input type="text" id="apiCompanyName" class="form-control" placeholder="Auto-filled from Google">
        </div>
        <div class="mb-2">
          <label class="form-label">Google Place ID</label>
          <input type="text" id="apiCompanyPlaceId" class="form-control" placeholder="Auto-filled from Google">
        </div>
        <div class="mb-2">
          <label class="form-label">City</label>
          <input type="text" id="apiCompanyCity" class="form-control" placeholder="Auto-filled" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Country</label>
          <input type="text" id="apiCompanyCountry" class="form-control" placeholder="Auto-filled" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Website</label>
          <input type="url" id="apiCompanyWebsite" class="form-control" placeholder="Auto-filled">
        </div>
        <div class="mb-2">
          <label class="form-label">Phone</label>
          <input type="text" id="apiCompanyPhone" class="form-control" placeholder="Auto-filled">
        </div>
        <div class="mb-3">
          <label class="form-label">API Token (if required)</label>
          <input type="password" id="apiToken" class="form-control" placeholder="••••••••••">
        </div>
        <button class="btn btn-primary w-100" onclick="addCompanyViaApi()">Create Company</button>
      </div>
    </div>
  </div>
</div>

<!-- Owner Summary Modal -->
<div class="modal fade" id="ownerSummaryModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5>AI Owner Summary</h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="owner-summary-content"></div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="copySummary()">Copy</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ------------------------------
  // State
  // ------------------------------
  let currentCompany = null;
  let trendChart, sentimentChart;
  let currentSummaryData = null;

  // ------------------------------
  // Utilities
  // ------------------------------
  const $ = (id) => document.getElementById(id);
  const escapeHtml = (str = '') =>
    str.replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s] || s));
  function setLoadingMetrics(isLoading) {
    ['metricTotal','metricAvg','metricRisk'].forEach(id => {
      const el = $(id);
      if (isLoading) { el.classList.add('skeleton'); el.textContent = ' '; }
      else { el.classList.remove('skeleton'); }
    });
  }
  function fmtNumber(n, decimals=0) { return Number.isFinite(n) ? n.toFixed(decimals) : '0'; }
  function fmtDateISO(d) {
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  // ------------------------------
  // Load companies
  // ------------------------------
  async function loadCompanies() {
    try {
      const res = await fetch('/companies');
      if (!res.ok) throw new Error('companies fetch failed');
      const companies = await res.json();
      const select = $('companySelect');
      select.innerHTML = '';
      companies.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        select.appendChild(option);
      });
      if (companies.length) {
        currentCompany = currentCompany ?? companies[0].id;
        select.value = String(currentCompany);
        await loadSummary();
      }
      select.onchange = async () => {
        currentCompany = select.value;
        clearAttrs();
        await loadSummary();
      };
    } catch (e) {
      console.error(e);
      toast('Could not load companies.', 'danger');
    }
  }

  // ------------------------------
  // Date range
  // ------------------------------
  function initDefaultDates() {
    // Default start: 2026-02-23 (your example); End: today
    $('startDate').value = $('startDate').value || '2026-02-23';
    $('endDate').value = $('endDate').value || fmtDateISO(new Date());
  }
  function applyDateRange() { loadSummary(); }

  // ------------------------------
  // Summary (single fetch, supports ?start=&end=)
  // ------------------------------
  async function loadSummary() {
    if (!currentCompany) return;
    setLoadingMetrics(true);
    $('trendHint').textContent = '';
    try {
      const start = $('startDate').value?.trim();
      const end = $('endDate').value?.trim();
      const qs = new URLSearchParams();
      if (start) qs.set('start', start);
      if (end) qs.set('end', end);
      const url = qs.toString() ? `/reviews/summary/${currentCompany}?${qs.toString()}` : `/reviews/summary/${currentCompany}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('summary fetch failed');
      const data = await res.json();
      currentSummaryData = data;

      $('metricTotal').textContent = fmtNumber(data.total_reviews, 0);
      $('metricAvg').textContent = fmtNumber(data.avg_rating, 2);
      $('metricRisk').textContent = fmtNumber(data.risk_score, 0) + '%';

      const badge = $('riskBadge');
      badge.className = 'badge';
      if (data.risk_level === 'High') badge.classList.add('badge-risk-high');
      else if (data.risk_level === 'Medium') badge.classList.add('badge-risk-medium');
      else badge.classList.add('badge-risk-low');
      badge.textContent = data.risk_level;

      const w = data.window || {};
      $('activeWindowNote').textContent = (w.start && w.end)
        ? `Window: ${new Date(w.start).toLocaleDateString()} → ${new Date(w.end).toLocaleDateString()}`
        : '';

      if (data.trend && data.trend.signal !== undefined) {
        const s = data.trend.signal; const d = Number(data.trend.delta || 0);
        $('trendHint').textContent = s === 'improving' ? `Improving (+${fmtNumber(d,2)})`
                                 : s === 'declining' ? `Declining (${fmtNumber(d,2)})`
                                 : s === 'stable' ? `Stable (${fmtNumber(d,2)})` : '';
      }

      renderCharts(data);
      renderRecommendations(data.ai_recommendations || []);
    } catch (e) {
      console.error(e);
      toast('Could not load summary.', 'danger');
    } finally {
      setLoadingMetrics(false);
    }
  }

  // ------------------------------
  // Fetch Google attributes for selected company
  // ------------------------------
  function clearAttrs() {
    $('companyAttrs').innerHTML = '<div class="text-muted">Click <strong>Fetch Google Details</strong> to load attributes for the selected company.</div>';
    $('attrsStatus').textContent = '';
  }

  async function fetchGoogleDetails() {
    if (!currentCompany) return;
    $('attrsStatus').textContent = 'Loading...';
    try {
      const res = await fetch(`/reviews/company/${currentCompany}/google_details`);
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) {
        throw new Error(data.reason || 'Failed to fetch Google details');
      }
      $('attrsStatus').textContent = data.refreshed ? 'Updated from Google' : 'Loaded';
      renderAttrs(data.details || {});
    } catch (e) {
      console.error(e);
      $('attrsStatus').textContent = 'Error';
      toast('Failed to fetch Google details. Check API key.', 'danger');
    }
  }

  function cell(label, valueHtml) {
    return `
      <div class="d-flex align-items-start mb-2">
        <div class="attr-label">${escapeHtml(label)}</div>
        <div class="flex-grow-1">${valueHtml || '<span class="text-muted">—</span>'}</div>
      </div>
    `;
  }

  function renderAttrs(d) {
    const name = escapeHtml(d.name || '');
    const place = escapeHtml(d.place_id || '');
    const addr = escapeHtml(d.formatted_address || '');
    const city = escapeHtml(d.city || '');
    const country = escapeHtml(d.country || '');
    const website = d.website ? `<a href="${escapeHtml(d.website)}" target="_blank" class="truncate">${escapeHtml(d.website)}</a>` : '';
    const phone = escapeHtml(d.international_phone_number || d.phone || '');
    const rating = (d.rating != null) ? `${escapeHtml(String(d.rating))} (${escapeHtml(String(d.user_ratings_total || 0))})` : '';

    $('companyAttrs').innerHTML = `
      ${cell('Name', `<strong>${name}</strong>`)}
      ${cell('Place ID', `<code class="truncate">${place}</code>`)}
      ${cell('Address', addr)}
      ${cell('City', city)}
      ${cell('Country', country)}
      ${cell('Website', website)}
      ${cell('Phone', phone)}
      ${cell('Google Rating', rating)}
      ${cell('Coordinates', d.location ? `${escapeHtml(String(d.location.lat))}, ${escapeHtml(String(d.location.lng))}` : '')}
      ${d.opening_hours ? cell('Opening Hours', (d.opening_hours.weekday_text || []).map(x => `<div>${escapeHtml(x)}</div>`).join('')) : ''}
    `;
  }

  // ------------------------------
  // Charts (prefer daily_series if available)
  // ------------------------------
  function renderCharts(data) {
    const primary = '#0d6efd';
    const gridColor = 'rgba(0,0,0,0.1)';
    // Trend line (daily_series or monthly trend_data)
    let labels = [], values = [];
    if (Array.isArray(data.daily_series) && data.daily_series.length) {
      labels = data.daily_series.map(d => new Date(d.date).toLocaleDateString(undefined, { day: '2-digit', month: 'short' }));
      values = data.daily_series.map(d => (Number.isFinite(d.avg_rating) ? d.avg_rating : null));
    } else if (Array.isArray(data.trend_data) && data.trend_data.length) {
      labels = data.trend_data.map(t => {
        const [y, m] = (t.month || '').split('-').map(Number);
        if (!y || !m) return t.month || '';
        const d = new Date(Date.UTC(y, m - 1, 1));
        return d.toLocaleString(undefined, { month: 'short', year: 'numeric' });
      });
      values = data.trend_data.map(t => t.avg_rating);
    }
    if (trendChart) trendChart.destroy();
    trendChart = new Chart($('trendChart'), {
      type: 'line',
      data: { labels, datasets: [{ label: 'Avg Rating', data: values, borderColor: primary, backgroundColor: 'rgba(13,110,253,0.08)', tension: .3, spanGaps:true, fill:true, pointRadius:2 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ y:{ min:0, max:5, grid:{ color:gridColor } }, x:{ grid:{ display:false } } } }
    });

    // Sentiment doughnut
    const sentiments = data.sentiments || { Positive:0, Neutral:0, Negative:0 };
    const sData = [sentiments.Positive||0, sentiments.Neutral||0, sentiments.Negative||0];
    if (sentimentChart) sentimentChart.destroy();
    sentimentChart = new Chart($('sentimentChart'), {
      type: 'doughnut',
      data: { labels:['Positive','Neutral','Negative'], datasets:[{ data: sData, backgroundColor: ['#28a745', '#adb5bd', '#dc3545'], borderWidth:0 }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, cutout:'60%' }
    });
  }

  // ------------------------------
  // Recommendations & Summary modal
  // ------------------------------
  function renderRecommendations(list) {
    const container = $('recommendations');
    container.innerHTML = '';
    if (!list || !list.length) {
      container.innerHTML = '<div class="text-muted">No recommendations available yet.</div>';
      return;
    }
    list.forEach(r => {
      container.innerHTML += `
        <div class="border rounded p-2 mb-2">
          <strong>${escapeHtml(r.area)}</strong> (${escapeHtml(r.priority)})<br>
          ${escapeHtml(r.action)}
        </div>`;
    });
  }

  function openOwnerSummary() {
    const container = $('owner-summary-content');
    const d = currentSummaryData;
    if (!d) return;
    const items = (d.ai_recommendations || []).map(r => `<li><strong>${escapeHtml(r.area)}</strong>: ${escapeHtml(r.action)}</li>`).join('');
    const windowText = d.window ? `<div class="small text-muted">Window: ${new Date(d.window.start).toLocaleDateString()} → ${new Date(d.window.end).toLocaleDateString()}</div>` : '';
    container.innerHTML = `
      <h5>Executive Overview</h5>
      ${windowText}
      <p>${fmtNumber(d.total_reviews)} reviews analysed. Average rating ${fmtNumber(d.avg_rating,2)}. Risk ${fmtNumber(d.risk_score,0)}%.</p>
      <h5 class="mt-3">Action Plan</h5>
      <ul>${items}</ul>
    `;
    new bootstrap.Modal($('ownerSummaryModal')).show();
  }

  function copySummary() {
    const text = $('owner-summary-content').innerText;
    if (!navigator.clipboard) {
      const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      toast('Copied to clipboard.', 'success'); return;
    }
    navigator.clipboard.writeText(text).then(()=>toast('Copied to clipboard.','success')).catch(()=>toast('Copy failed.','danger'));
  }

  // ------------------------------
  // Sync
  // ------------------------------
  async function syncReviews() {
    if (!currentCompany) return;
    const btn = $('btnSync'), spinner = btn.querySelector('.spinner-border'), label = btn.querySelector('.sync-label');
    try {
      btn.disabled = true; spinner.classList.remove('d-none'); label.textContent = 'Syncing...';
      const res = await fetch(`/reviews/sync/${currentCompany}`);
      const data = await res.json().catch(()=>({}));
      if (!res.ok || data.ok === false) throw new Error(data.reason || 'Sync failed');
      toast(`Synced. Added: ${data.added || 0}`, 'success');
      await loadSummary();
    } catch (e) {
      console.error(e);
      toast('Sync failed.', 'danger');
    } finally {
      btn.disabled = false; spinner.classList.add('d-none'); label.textContent = 'Sync';
    }
  }

  // ------------------------------
  // Add Company: Google search + Create
  // ------------------------------
  async function searchPlace() {
    const q = $('placeQuery').value.trim();
    const $res = $('searchResults');
    if (!q) { $res.innerHTML = '<div class="text-muted">Enter a business name or query.</div>'; return; }
    $res.innerHTML = '<div class="text-muted">Searching...</div>';
    try {
      const r = await fetch(`/reviews/google/places?q=${encodeURIComponent(q)}`);
      const data = await r.json().catch(()=>({}));
      if (!r.ok || data.ok === false) throw new Error(data.reason || 'Search failed');
      const items = data.items || [];
      if (!items.length) { $res.innerHTML = '<div class="text-muted">No matches found.</div>'; return; }
      $res.innerHTML = items.map(it => `
        <div class="border rounded p-2 mb-2">
          <div><strong>${escapeHtml(it.name || '')}</strong></div>
          <div class="small text-muted">${escapeHtml(it.formatted_address || '')}</div>
          <div class="small">City: ${escapeHtml(it.city || '—')}, Country: ${escapeHtml(it.country || '—')}</div>
          <div class="small">Phone: ${escapeHtml(it.international_phone_number || it.phone || '—')}</div>
          <div class="small">Website: ${it.website ? `<a href="${escapeHtml(it.website)}" target="_blank">${escapeHtml(it.website)}</a>` : '—'}</div>
          <div class="small">Rating: ${escapeHtml(String(it.rating ?? '—'))} (${escapeHtml(String(it.user_ratings_total ?? 0))})</div>
          <div class="small text-break">Place ID: <code>${escapeHtml(it.place_id || '')}</code></div>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="useResult('${encodeURIComponent(JSON.stringify(it))}')">Use</button>
          </div>
        </div>
      `).join('');
    } catch (e) {
      console.error(e);
      $res.innerHTML = '<div class="text-danger">Search failed. Ensure Google API is configured.</div>';
    }
  }

  function useResult(encoded) {
    const it = JSON.parse(decodeURIComponent(encoded));
    $('apiCompanyName').value = it.name || '';
    $('apiCompanyPlaceId').value = it.place_id || '';
    $('apiCompanyCity').value = it.city || '';
    $('apiCompanyCountry').value = it.country || '';
    $('apiCompanyWebsite').value = it.website || '';
    $('apiCompanyPhone').value = it.international_phone_number || it.phone || '';
    toast('Fields auto-filled from Google.', 'success');
  }

  async function addCompanyViaApi() {
    const name = $('apiCompanyName').value.trim();
    const place_id = $('apiCompanyPlaceId').value.trim();
    const website = $('apiCompanyWebsite').value.trim();
    const location = [$('apiCompanyCity').value.trim(), $('apiCompanyCountry').value.trim()].filter(Boolean).join(', ');
    const token = $('apiToken').value.trim();
    if (!name || !place_id) { toast('Name and Place ID are required (use Google Search above).', 'warning'); return; }
    try {
      const res = await fetch('/reviews/company', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', ...(token ? { 'X-API-Key': token } : {}) },
        body: JSON.stringify({ name, place_id, website, location })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok || data.ok === false) throw new Error(data.detail || data.reason || 'Create failed');
      toast('Company created.', 'success');
      const modalEl = document.getElementById('addCompanyModal');
      bootstrap.Modal.getInstance(modalEl)?.hide();
      await loadCompanies();
    } catch (e) {
      console.error(e);
      toast('Create failed.', 'danger');
    }
  }

  // ------------------------------
  // Toasts
  // ------------------------------
  function toast(message, type='primary') {
    const id = `t-${Date.now()}`;
    const wrap = document.createElement('div');
    wrap.className = 'position-fixed top-0 end-0 p-3';
    wrap.style.zIndex = 1080;
    wrap.innerHTML = `
      <div id="${id}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${escapeHtml(message)}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    document.body.appendChild(wrap);
    const t = new bootstrap.Toast($(id), { delay: 2500 });
    t.show();
    setTimeout(()=>wrap.remove(), 3000);
  }

  // ------------------------------
  // Init
  // ------------------------------
  document.addEventListener('DOMContentLoaded', async () => {
    initDefaultDates();
    await loadCompanies();
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
