{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h3 class="mb-0">Review Intelligence Dashboard</h3>

    <div class="d-flex align-items-center gap-3 flex-wrap">
      <select id="company-selector" class="form-select" style="min-width: 260px;">
        <option value="0">Select a Company...</option>
      </select>

      <!-- Add Company -->
      <button id="add-company-btn" class="btn btn-outline-dark">
        <i class="bi bi-building-add"></i> Add Company
      </button>

      <!-- Date range: from / to -->
      <div class="d-flex align-items-center gap-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
          <input id="date-from" type="date" class="form-control" aria-label="Date From" />
        </div>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-date-fill"></i></span>
          <input id="date-to" type="date" class="form-control" aria-label="Date To" />
        </div>
      </div>

      <button id="apply-range-btn" class="btn btn-outline-primary">
        <i class="bi bi-funnel"></i> Apply Date Range
      </button>

      <button id="refresh-btn" class="btn btn-outline-success">
        <i class="bi bi-arrow-repeat"></i> Refresh & Fetch Latest
      </button>

      <button id="owner-summary-btn" class="btn btn-primary" disabled>
        <i class="bi bi-stars"></i> Owner Summary
      </button>
    </div>
  </div>

  <div class="card shadow mb-4 border-0" id="company-header" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h4 id="company-name" class="mb-1 text-primary">Company Name</h4>
          <div class="text-muted small">
            <span>Google Rating: <strong id="google-rating" class="text-dark">—</strong></span> •
            <span>Total Ratings: <strong id="google-total-ratings" class="text-dark">—</strong></span>
          </div>
        </div>

        <div class="text-end small">
          <div class="text-muted">
            Analysis Window: <span id="date-window" class="fw-bold text-dark">21 Feb 2026 → Today</span>
          </div>
          <div class="text-muted">
            Sync Status: <span id="last-refresh" class="text-success">—</span>
          </div>
        </div>
      </div>
      <!-- Executive summary quick line -->
      <div id="executive-summary-line" class="text-muted small mt-2" style="display:none;">
        <i class="bi bi-info-circle"></i> <span id="executive-summary-text">—</span>
      </div>
    </div>
  </div>

  <div id="loading-state" class="text-center py-5 my-5" style="display: none;">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;" role="status"></div>
    <p class="lead text-muted">Analyzing sentiment and extracting insights... (Approx. 5-20s)</p>
    <small class="text-muted">Connecting to Google Places API and generating AI recommendations.</small>
  </div>

  <div id="no-selection-state" class="alert alert-light border text-center py-5 my-5 shadow-sm">
    <i class="bi bi-building-up fs-1 mb-3 d-block text-primary"></i>
    <h5>Business Intelligence Ready</h5>
    <p class="text-muted">Please select a company and date range to begin the analysis.</p>
  </div>

  <div id="main-content" style="display: none;">
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-primary border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-3">Total Reviews</h6>
            <h2 id="total-reviews" class="display-6 fw-bold">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-success border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-3">Average Rating</h6>
            <h2 id="avg-rating" class="display-6 fw-bold">0.0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-warning border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-2">Sentiment Mix</h6>
            <h3 id="sentiment-mix" class="fw-bold mb-2">0 / 0 / 0</h3>
            <div class="mt-1">
              <span class="badge bg-success-subtle text-success border border-success me-1">Pos</span>
              <span class="badge bg-warning-subtle text-warning border border-warning me-1">Neu</span>
              <span class="badge bg-danger-subtle text-danger border border-danger">Neg</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-danger border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-2">Risk Score</h6>
            <div style="height: 60px;">
              <canvas id="riskGauge"></canvas>
            </div>
            <div class="mt-2">
              <span id="risk-score-text" class="badge rounded-pill bg-secondary px-3">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <div class="d-flex align-items-center mb-3">
              <i class="bi bi-robot text-primary fs-4 me-2"></i>
              <h5 class="card-title mb-0">AI Recommended Improvement Plan</h5>
            </div>
            <div id="ai-recs" class="list-group list-group-flush border rounded overflow-hidden"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h6 class="card-title mb-3">Data Accuracy</h6>
            <div class="progress" style="height: 12px;">
              <div id="data-completion-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted d-block mt-2">Sync Status: <span id="data-completion-text">0%</span> of Google database indexed.</small>

            <hr class="my-4">
            <h6 class="card-title d-flex justify-content-between">
              Top Weak Areas <i class="bi bi-graph-down-arrow text-danger"></i>
            </h6>
            <div id="weak-areas-chips" class="d-flex flex-wrap gap-2 mt-2"></div>

            <hr class="my-4">
            <h6 class="card-title d-flex justify-content-between">
              Top Strength Areas <i class="bi bi-graph-up-arrow text-success"></i>
            </h6>
            <div id="strength-areas-chips" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Historical Rating Trend</h5>
            <div style="height: 360px;">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-3">Customer Sentiment Distribution</h5>
            <div style="height: 320px;">
              <canvas id="sentimentPie"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Keyword Impact (Negative)</h5>
            <div style="height: 250px;">
              <canvas id="weakAreasChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Keyword Impact (Positive)</h5>
            <div style="height: 250px;">
              <canvas id="strengthAreasChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Aspect Matrix (Pos / Neu / Neg)</h5>
            <div style="height: 260px;">
              <canvas id="aspectMatrixChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0 bg-primary text-white">
          <div class="card-body text-center py-4">
            <h5 class="card-title">Reporting</h5>
            <p class="small opacity-75">Generate a full audit report for stakeholders.</p>
            <button class="btn btn-light w-100 fw-bold disabled">
              <i class="bi bi-file-earmark-pdf"></i> Export Intelligence (PDF)
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Top Negative Phrases</h5>
        <div id="phrases-cloud" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Intelligent Keywords Mapping</h5>
        <div id="keywords-cloud" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>

    <div class="card shadow-sm border-0 mt-4 overflow-hidden">
      <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Feedback & AI Suggestions</h5>
        <span class="badge bg-primary-subtle text-primary border border-primary">Live Data</span>
      </div>
      <div class="card-body p-0">
        <div id="reviews-container" class="list-group list-group-flush"></div>
      </div>
    </div>
  </div>
</div>

<!-- Add Company Modal -->
<div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="add-company-form" class="modal-content" autocomplete="off">
      <div class="modal-header">
        <h5 id="addCompanyModalLabel" class="modal-title"><i class="bi bi-building-add"></i> Add New Company</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
        </button>
      </div>
      <div class="modal-body">
        <!-- Google Places Autocomplete (like companies.html) -->
        <div class="mb-3">
          <label class="form-label">Search Company (Google)</label>
          <input type="text" id="addco_google_search" class="form-control" placeholder="Start typing company name..." />
          <div class="form-text">This will auto-fill name, city, address and Place ID.</div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Company Name <span class="text-danger">*</span></label>
            <input type="text" id="addco_name" class="form-control" required readonly />
          </div>
          <div class="col-md-6">
            <label class="form-label">City</label>
            <input type="text" id="addco_city" class="form-control" readonly />
          </div>

          <div class="col-12">
            <label class="form-label">Address</label>
            <input type="text" id="addco_address" class="form-control" readonly />
          </div>

          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input type="text" id="addco_phone" class="form-control" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" id="addco_email" class="form-control" />
          </div>

          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea id="addco_description" class="form-control" rows="3"></textarea>
          </div>
        </div>

        <!-- Hidden (same as companies.html) -->
        <input type="hidden" id="addco_lat" />
        <input type="hidden" id="addco_lng" />
        <input type="hidden" id="addco_place_id" />

        <div id="addco-alert" class="alert alert-danger d-none small mt-3"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button id="add-company-submit" type="submit" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Create Company
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap CSS (if not already provided by base.html) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<!-- Bootstrap JS bundle (for modal) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const FILE_NAME_HTML = "review_saas/app/templates/dashboard.html";
let trendChart, sentimentPieChart, weakAreasChart, strengthAreasChart, riskGaugeChart, aspectMatrixChart;
let currentCompanyId = 0;
let isFetching = false;
let lastSummaryData = null; // cache the one-shot payload for Owner Summary
let addCoPlacesAutocomplete = null;

const colors = { 
  primary:'#0d6efd', 
  success:'#198754', 
  warning:'#ffc107', 
  danger:'#dc3545', 
  gray:'#6c757d', 
  light:'#f8f9fa' 
};

// ── Initialization ──
document.addEventListener('DOMContentLoaded', () => {
  initDefaultDates();            // default from 2026-02-21 to today
  updateDateWindowDisplay();
  loadCompanies();

  document.getElementById('apply-range-btn').addEventListener('click', () => {
    if (currentCompanyId > 0) loadDashboardData(currentCompanyId, false);
  });

  document.getElementById('refresh-btn').addEventListener('click', () => {
    if (currentCompanyId > 0) loadDashboardData(currentCompanyId, true);
  });

  document.getElementById('owner-summary-btn').addEventListener('click', () => {
    if (!lastSummaryData) return;
    populateOwnerSummaryModal(lastSummaryData);
    const modalEl = document.getElementById('ownerSummaryModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
  });

  // Add Company open modal
  document.getElementById('add-company-btn').addEventListener('click', () => {
    clearAddCompanyForm();
    const modalEl = document.getElementById('addCompanyModal');
    bootstrap.Modal.getOrCreateInstance(modalEl).show();

    // Lazy init Places Autocomplete (only when modal opens)
    if (!addCoPlacesAutocomplete && window.google?.maps?.places) {
      addCoPlacesAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('addco_google_search'),
        { types: ['establishment'] }
      );
      addCoPlacesAutocomplete.addListener('place_changed', handleAddCoPlacePicked);
    }
  });

  // Add Company submit
  document.getElementById('add-company-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    await submitNewCompany();
  });

  // Update date-window text on input changes (for UX)
  document.getElementById('date-from').addEventListener('change', updateDateWindowDisplay);
  document.getElementById('date-to').addEventListener('change', updateDateWindowDisplay);
});

function initDefaultDates() {
  // Default: From 2026-02-21 (fixed) to Today (backend default)
  const df = new Date(Date.UTC(2026, 1, 21)); // 0-indexed month
  const dt = new Date();

  const fmtISO = d => {
    const z = new Date(d);
    const yyyy = z.getFullYear();
    const mm = String(z.getMonth() + 1).padStart(2, '0');
    const dd = String(z.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
  };

  document.getElementById('date-from').value = fmtISO(df);
  document.getElementById('date-to').value = fmtISO(dt);
}

function getDateInputs() {
  const df = document.getElementById('date-from').value;
  const dt = document.getElementById('date-to').value;
  if(!df || !dt) return { date_from: null, date_to: null };

  let start = new Date(df + "T00:00:00");
  let end = new Date(dt + "T23:59:59");
  if (end < start) { const tmp = start; start = end; end = tmp; }

  const fmtISO = d => d.toISOString().slice(0,10);
  return { date_from: fmtISO(start), date_to: fmtISO(end) };
}

function formatDateForDisplay(isoDate) {
  const d = new Date(isoDate);
  return d.toLocaleDateString(undefined, { day:'2-digit', month:'short', year:'numeric' });
}

function updateDateWindowDisplay(){
  const { date_from, date_to } = getDateInputs();
  if(date_from && date_to) {
    document.getElementById('date-window').textContent =
      `${formatDateForDisplay(date_from)} → ${formatDateForDisplay(date_to)}`;
  } else {
    document.getElementById('date-window').textContent = "—";
  }
}

async function loadCompanies() {
  try {
    // Use existing endpoint used in dashboard (simple list)
    const res = await fetch('/reviews/my-companies');
    if(!res.ok) throw new Error('Network error loading companies');
    const companies = await res.json();
    const select = document.getElementById('company-selector');
    
    select.innerHTML = '<option value="0">Select a Company...</option>';
    companies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.name} (${c.city})`;
      select.appendChild(opt);
    });

    select.addEventListener('change', async e => {
      currentCompanyId = parseInt(e.target.value);
      if(currentCompanyId > 0) {
        await loadDashboardData(currentCompanyId, false);
      } else {
        showNoSelection();
      }
    });
  } catch(err) {
    console.error(`[${FILE_NAME_HTML}] Init error:`, err);
  }
}

async function loadDashboardData(companyId, forceRefresh=false){
  if(isFetching) return;
  isFetching = true;
  
  // UI Transitions
  document.getElementById('loading-state').style.display = 'block';
  document.getElementById('no-selection-state').style.display = 'none';
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('company-header').style.display = 'none';
  document.getElementById('owner-summary-btn').disabled = true;
  document.getElementById('executive-summary-line').style.display = 'none';

  try {
    const { date_from, date_to } = getDateInputs();
    updateDateWindowDisplay();

    const qp = new URLSearchParams();
    if (date_from) qp.set('date_from', date_from);
    if (date_to) qp.set('date_to', date_to);
    qp.set('refresh', String(!!forceRefresh));

    const url = `/reviews/summary/${companyId}?` + qp.toString();
    const res = await fetch(url);
    if(!res.ok) throw new Error(`API Error: ${res.status}`);
    const data = await res.json();
    lastSummaryData = data;

    // Populate Data
    document.getElementById('company-name').textContent = data.company_name || '';
    document.getElementById('google-rating').textContent = data.google_rating ?? 'N/A';
    document.getElementById('google-total-ratings').textContent = data.google_total_ratings ?? '0';
    document.getElementById('total-reviews').textContent = data.total_reviews ?? 0;
    document.getElementById('avg-rating').textContent = (data.avg_rating ?? 0).toFixed(1);
    document.getElementById('sentiment-mix').textContent = 
      `${(data.sentiments?.Positive ?? 0)} / ${(data.sentiments?.Neutral ?? 0)} / ${(data.sentiments?.Negative ?? 0)}`;
    document.getElementById('last-refresh').textContent = forceRefresh ? "Just Now" : "Synced";

    if (data.executive_summary) {
      document.getElementById('executive-summary-text').textContent = data.executive_summary;
      document.getElementById('executive-summary-line').style.display = 'block';
    }

    // Data Completion Bar
    const completion = computeCompletionPercent(data);
    const bar = document.getElementById('data-completion-bar');
    bar.style.width = `${completion}%`;
    document.getElementById('data-completion-text').textContent = `${completion}%`;
    bar.className = 'progress-bar ' + (completion > 80 ? 'bg-success' : completion > 50 ? 'bg-warning' : 'bg-danger');

    // Analytics Components
    renderChips('weak-areas-chips', data.weak_areas, 'danger');
    renderChips('strength-areas-chips', data.strength_areas, 'success');
    renderKeywordsCloud(data.positive_keywords, data.negative_keywords);
    renderTopNegativePhrases(data.top_phrases_negative);
    renderReviews(data.reviews);
    renderAIRecommendations(data.ai_recommendations);
    
    // Charts
    initCharts(data);

    // Enable Owner Summary button
    document.getElementById('owner-summary-btn').disabled = false;

    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('company-header').style.display = 'block';

  } catch(err) {
    console.error(`[${FILE_NAME_HTML}] Load Error:`, err);
    alert("Critical failure while fetching analytics. Check server logs.");
  } finally {
    isFetching = false;
  }
}

function computeCompletionPercent(data) {
  if (typeof data.data_completion_percent === 'number') {
    return Math.min(100, Math.max(0, Math.round(data.data_completion_percent)));
  }
  const totalGoogle = Number(data.google_total_ratings ?? 0);
  const totalInWindow = Number(data.total_reviews ?? 0);
  if (totalGoogle <= 0) return 0;
  return Math.min(100, Math.round((totalInWindow / totalGoogle) * 100));
}

function renderChips(id, items, type) {
  const container = document.getElementById(id);
  container.innerHTML = '';
  if(!items || items.length === 0) {
    container.innerHTML = '<span class="text-muted small">No data detected.</span>';
    return;
  }
  items.forEach(i => {
    const chip = document.createElement('span');
    const label = (i.keyword ?? i.k ?? i.term ?? '—');
    const mentions = (i.mentions ?? i.count ?? 0);
    chip.className = `badge rounded-pill bg-${type}-subtle text-${type} border border-${type} px-3`;
    chip.textContent = `${label} (${mentions})`;
    container.appendChild(chip);
  });
}

function renderTopNegativePhrases(phrases) {
  const container = document.getElementById('phrases-cloud');
  container.innerHTML = '';
  const items = Array.isArray(phrases) ? phrases : [];
  if(items.length === 0) {
    container.innerHTML = '<span class="text-muted">No dominant phrases detected.</span>';
    return;
  }
  items.forEach(p => {
    const span = document.createElement('span');
    span.className = 'badge bg-light text-danger border px-3 py-2';
    span.textContent = `${p.phrase} (${p.mentions})`;
    container.appendChild(span);
  });
}

function renderKeywordsCloud(pos, neg) {
  const container = document.getElementById('keywords-cloud');
  container.innerHTML = '';
  const positive = Array.isArray(pos) ? pos : [];
  const negative = Array.isArray(neg) ? neg.map(o => (typeof o === 'string' ? o : o.keyword)).filter(Boolean) : [];

  const items = [
    ...positive.map(k => ({k, type: 'success'})),
    ...negative.map(k => ({k, type: 'danger'}))
  ];
  if(items.length === 0) container.innerHTML = '<span class="text-muted">Insufficient text data.</span>';
  items.forEach(item => {
    const span = document.createElement('span');
    span.className = `badge bg-light text-${item.type} border px-3 py-2`;
    span.textContent = item.k;
    container.appendChild(span);
  });
}

function renderAIRecommendations(recs) {
  const container = document.getElementById('ai-recs');
  container.innerHTML = '';
  if(!recs || recs.length === 0) {
    container.innerHTML = '<div class="p-4 text-center text-muted">Awaiting more negative feedback data to generate recommendations.</div>';
    return;
  }
  recs.forEach(r => {
    const item = document.createElement('div');
    item.className = "list-group-item p-3 border-0 border-bottom";
    const pr = r.priority || 'Medium';
    item.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="badge bg-danger-subtle text-danger px-2 py-1">Area: ${r.weak_area ?? '—'}</span>
        <span class="badge bg-${pr === 'High' ? 'danger' : pr === 'Low' ? 'success' : 'warning'}">${pr} Priority</span>
      </div>
      <p class="mb-2 fw-bold text-dark"><i class="bi bi-lightbulb text-warning me-1"></i> ${r.recommended_action ?? ''}</p>
      <div class="small text-muted"><i class="bi bi-check-circle text-success me-1"></i> ${r.expected_outcome ?? ''}</div>
      <div class="small text-muted mt-1"><i class="bi bi-bullseye"></i> KPI: ${r.kpi ?? ''}</div>
      <div class="small text-muted"><i class="bi bi-person-badge"></i> Owner: ${r.owner ?? 'Ops Lead'} • ${r.timeframe ?? ''}</div>
    `;
    container.appendChild(item);
  });
}

function renderReviews(reviews) {
  const container = document.getElementById('reviews-container');
  container.innerHTML = '';
  if(!reviews || reviews.length === 0) {
    container.innerHTML = '<div class="p-5 text-center text-muted">No reviews in the selected date range.</div>';
    return;
  }
  reviews.forEach(rev => {
    const div = document.createElement('div');
    const stars = Math.round(rev.rating || 0);
    const safeDate = rev.review_date ? new Date(rev.review_date).toLocaleDateString() : '—';
    const chipType = rev.sentiment==='Positive' ? 'success' : (rev.sentiment==='Negative' ? 'danger' : 'warning');

    div.className = "list-group-item p-4";
    div.innerHTML = `
      <div class="d-flex justify-content-between mb-2">
        <div>
          <h6 class="mb-0 fw-bold">${rev.reviewer_name ?? 'Anonymous'}</h6>
          <small class="text-muted">${safeDate}</small>
        </div>
        <div class="text-end">
          <div class="text-warning mb-1">${'★'.repeat(stars)}${'☆'.repeat(Math.max(0, 5 - stars))}</div>
          <span class="badge bg-${chipType}-subtle text-${chipType}">${rev.sentiment ?? ''}</span>
        </div>
      </div>
      <p class="text-secondary small mb-3 italic">"${rev.review_text ?? ''}"</p>
      <div class="bg-light p-3 rounded border">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="small fw-bold text-primary"><i class="bi bi-stars"></i> Suggested AI Reply:</span>
          <button class="btn btn-sm btn-link p-0 text-decoration-none" onclick="copyText(this, \`${rev.suggested_reply ?? ''}\`)"><i class="bi bi-clipboard"></i> Copy</button>
        </div>
        <div class="small text-dark">${rev.suggested_reply ?? ''}</div>
      </div>
    `;
    container.appendChild(div);
  });
}

function copyText(btn, text) {
  navigator.clipboard.writeText(text ?? '');
  const original = btn.innerHTML;
  btn.innerHTML = '<i class="bi bi-check2"></i> Copied';
  setTimeout(() => btn.innerHTML = original, 2000);
}

function initCharts(data) {
  // Destroy previous instances
  [trendChart, sentimentPieChart, weakAreasChart, strengthAreasChart, riskGaugeChart, aspectMatrixChart].forEach(c => c?.destroy());

  // 1. Trend Chart
  trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: {
      labels: (data.trend_data || []).map(t => t.month),
      datasets: [{
        label: 'Avg Rating',
        data: (data.trend_data || []).map(t => t.avg_rating),
        borderColor: colors.primary,
        backgroundColor: 'rgba(13, 110, 253, 0.1)',
        fill: true,
        tension: 0.4,
        yAxisID: 'y'
      }, {
        label: 'Review Count',
        data: (data.trend_data || []).map(t => t.count),
        type: 'bar',
        backgroundColor: 'rgba(108, 117, 125, 0.2)',
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { min: 0, max: 5, position: 'left' },
        y1: { position: 'right', grid: { display: false } }
      }
    }
  });

  // 2. Sentiment Pie
  const pos = data.sentiments?.Positive ?? 0;
  const neu = data.sentiments?.Neutral ?? 0;
  const neg = data.sentiments?.Negative ?? 0;

  sentimentPieChart = new Chart(document.getElementById('sentimentPie'), {
    type: 'doughnut',
    data: {
      labels: ['Positive', 'Neutral', 'Negative'],
      datasets: [{
        data: [pos, neu, neg],
        backgroundColor: [colors.success, colors.warning, colors.danger]
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
  });

  // 3. Weak Areas Horizontal Bar
  const weakAreas = (data.weak_areas || []).map(w => ({kw: w.keyword, m: w.mentions}));
  weakAreasChart = new Chart(document.getElementById('weakAreasChart'), {
    type: 'bar',
    data: {
      labels: weakAreas.map(w => w.kw),
      datasets: [{
        data: weakAreas.map(w => w.m),
        backgroundColor: 'rgba(220, 53, 69, 0.7)',
        borderRadius: 5
      }]
    },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });

  // 4. Strength Areas Horizontal Bar
  const strengthAreas = (data.strength_areas || []).map(s => ({kw: s.keyword, m: s.mentions}));
  strengthAreasChart = new Chart(document.getElementById('strengthAreasChart'), {
    type: 'bar',
    data: {
      labels: strengthAreas.map(s => s.kw),
      datasets: [{
        data: strengthAreas.map(s => s.m),
        backgroundColor: 'rgba(25, 135, 84, 0.7)',
        borderRadius: 5
      }]
    },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });

  // 5. Risk Gauge
  const risk = Number(data.risk_score ?? 0);
  const riskText = document.getElementById('risk-score-text');
  riskText.textContent = `Risk: ${risk}%`;
  riskText.className = `badge rounded-pill px-3 ${risk > 60 ? 'bg-danger' : risk > 30 ? 'bg-warning' : 'bg-success'}`;

  riskGaugeChart = new Chart(document.getElementById('riskGauge'), {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [risk, 100 - risk],
        backgroundColor: [risk > 60 ? colors.danger : risk > 30 ? colors.warning : colors.success, '#eee'],
        circumference: 180,
        rotation: 270,
        borderWidth: 0
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { tooltip: { enabled: false } } }
  });

  // 6. Aspect Matrix (stacked bar Pos/Neu/Neg)
  const aspectObj = data.aspect_breakdown || {};
  const aspects = Object.keys(aspectObj);
  const posData = aspects.map(a => aspectObj[a]?.pos ?? 0);
  const neuData = aspects.map(a => aspectObj[a]?.neu ?? 0);
  const negData = aspects.map(a => aspectObj[a]?.neg ?? 0);

  aspectMatrixChart = new Chart(document.getElementById('aspectMatrixChart'), {
    type: 'bar',
    data: {
      labels: aspects,
      datasets: [
        { label: 'Positive', data: posData, backgroundColor: colors.success },
        { label: 'Neutral',  data: neuData, backgroundColor: colors.warning },
        { label: 'Negative', data: negData, backgroundColor: colors.danger }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });
}

function showNoSelection() {
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('company-header').style.display = 'none';
  document.getElementById('no-selection-state').style.display = 'block';
}

// ---- Add Company helpers (aligned with companies.html endpoints) ----
function clearAddCompanyForm() {
  ['addco_google_search','addco_name','addco_city','addco_address','addco_phone','addco_email','addco_description','addco_lat','addco_lng','addco_place_id']
  .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
  const alert = document.getElementById('addco-alert');
  alert.classList.add('d-none');
  alert.textContent = '';
}

function handleAddCoPlacePicked() {
  const place = addCoPlacesAutocomplete.getPlace();
  if (!place || !place.geometry) {
    showAddCoError('No location found from Google.');
    return;
  }

  // Fill fields like companies.html
  document.getElementById('addco_name').value = place.name || '';
  document.getElementById('addco_address').value = place.formatted_address || '';
  document.getElementById('addco_lat').value = place.geometry.location.lat();
  document.getElementById('addco_lng').value = place.geometry.location.lng();
  document.getElementById('addco_place_id').value = place.place_id || '';

  // Phone (if available in Places autocomplete details)
  document.getElementById('addco_phone').value = place.formatted_phone_number || '';

  // City extraction
  let city = '';
  if (Array.isArray(place.address_components)) {
    for (const comp of place.address_components) {
      if (comp.types?.includes('locality')) { city = comp.long_name; break; }
      if (comp.types?.includes('administrative_area_level_2') && !city) city = comp.long_name;
    }
  }
  document.getElementById('addco_city').value = city;
}

function showAddCoError(msg) {
  const alert = document.getElementById('addco-alert');
  alert.textContent = msg || 'Failed to add company.';
  alert.classList.remove('d-none');
}

async function submitNewCompany() {
  const name = document.getElementById('addco_name').value.trim();
  const city = document.getElementById('addco_city').value.trim();
  const address = document.getElementById('addco_address').value.trim();
  const phone = document.getElementById('addco_phone').value.trim();
  const email = document.getElementById('addco_email').value.trim();
  const description = document.getElementById('addco_description').value.trim();
  const lat = document.getElementById('addco_lat').value;
  const lng = document.getElementById('addco_lng').value;
  const place_id = document.getElementById('addco_place_id').value;

  if (!name || !place_id) {
    showAddCoError('Please search via Google and ensure Name and Place ID are filled.');
    return;
  }

  // Build FormData as companies.html expects
  const fd = new FormData();
  fd.append('name', name);
  fd.append('city', city);
  fd.append('address', address);
  fd.append('phone', phone);
  fd.append('email', email);
  fd.append('description', description);
  fd.append('lat', lat);
  fd.append('lng', lng);
  fd.append('place_id', place_id);

  try {
    const res = await fetch('/companies/', { method: 'POST', body: fd });
    if (!res.ok) {
      const err = await res.json().catch(()=>({detail:'Unknown error'}));
      throw new Error(err.detail || 'Failed to save');
    }
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('addCompanyModal')).hide();

    // Reload the dropdown from /reviews/my-companies
    await reloadCompanyDropdownAndSelectNew(name, city);

    // Immediately load analytics for the selected company
    if (currentCompanyId > 0) {
      await loadDashboardData(currentCompanyId, true);
    }
  } catch (e) {
    showAddCoError(e.message);
  }
}

async function reloadCompanyDropdownAndSelectNew(newName, newCity) {
  try {
    const res = await fetch('/reviews/my-companies');
    if (!res.ok) throw new Error('Cannot refresh companies list');
    const companies = await res.json();
    const select = document.getElementById('company-selector');
    select.innerHTML = '<option value="0">Select a Company...</option>';
    let foundId = 0;
    companies.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.name} (${c.city})`;
      select.appendChild(opt);
      // Try to auto-pick by name+city
      if (c.name === newName && (c.city || '') === (newCity || '')) {
        foundId = c.id;
      }
    });
    if (foundId) {
      select.value = foundId;
      currentCompanyId = foundId;
    }
  } catch (e) {
    console.warn('Dropdown refresh failed:', e);
  }
}
// ---- End Add Company helpers ----

function populateOwnerSummaryModal(data) {
  const exec = data?.executive_summary || '—';
  const riskScore = Number(data?.risk_score ?? 0);
  const plan = Array.isArray(data?.ai_recommendations) ? data.ai_recommendations : [];

  document.getElementById('owner-executive-summary').textContent = exec;
  const riskBadge = document.getElementById('owner-risk');
  riskBadge.textContent = `Risk: ${riskScore}%`;
  riskBadge.className = `badge rounded-pill ${riskScore > 60 ? 'bg-danger' : riskScore > 30 ? 'bg-warning' : 'bg-success'}`;

  const container = document.getElementById('owner-action-plan');
  container.innerHTML = '';

  const seen = new Set();
  const top5 = [];
  for (const r of plan) {
    const key = (r.weak_area || r.recommended_action || '').toLowerCase();
    if (key && !seen.has(key)) {
      seen.add(key);
      top5.push(r);
      if (top5.length >= 5) break;
    }
  }
  (top5.length ? top5 : plan.slice(0,5)).forEach(r => {
    const pr = r.priority || 'Medium';
    const item = document.createElement('div');
    item.className = 'list-group-item';
    item.innerHTML = `
      <div class="d-flex justify-content-between">
        <div class="fw-bold">${r.weak_area ?? '—'}</div>
        <span class="badge bg-${pr === 'High' ? 'danger' : pr === 'Low' ? 'success' : 'warning'}">${pr}</span>
      </div>
      <div class="small text-muted mt-1"><i class="bi bi-lightbulb"></i> ${r.recommended_action ?? ''}</div>
      <div class="small text-muted"><i class="bi bi-bullseye"></i> KPI: ${r.kpi ?? ''}</div>
      <div class="small text-muted"><i class="bi bi-people"></i> Owner: ${r.owner ?? 'Ops Lead'} • ${r.timeframe ?? ''}</div>
      <div class="small text-muted mt-1"><i class="bi bi-card-text"></i> ${r.rationale ?? ''}</div>
    `;
    container.appendChild(item);
  });
}

function buildOwnerSummaryClipboardText(data) {
  if (!data) return '';
  const lines = [];
  lines.push(`Company: ${data.company_name}`);
  lines.push(`Window: ${data.ai_observations?.window?.from} → ${data.ai_observations?.window?.to}`);
  lines.push(`Rating: ${data.avg_rating}★  | Reviews: ${data.total_reviews}`);
  lines.push(`Sentiment P/N/Ne: ${data.sentiments?.Positive}/${data.sentiments?.Negative}/${data.sentiments?.Neutral}`);
  lines.push(`Risk: ${data.risk_score}% (${data.risk_level})`);
  if (data.executive_summary) {
    lines.push('');
    lines.push('Executive Summary:');
    lines.push(data.executive_summary);
  }
  if (Array.isArray(data.ai_recommendations) && data.ai_recommendations.length) {
    lines.push('');
    lines.push('Top Actions:');
    data.ai_recommendations.slice(0,5).forEach((r, i) => {
      lines.push(`${i+1}. [${r.priority}] ${r.weak_area}: ${r.recommended_action}`);
      if (r.kpi) lines.push(`   KPI: ${r.kpi}`);
      if (r.timeframe || r.owner) lines.push(`   Owner: ${r.owner || '-'} • ${r.timeframe || ''}`);
    });
  }
  return lines.join('\n');
}
</script>

<!-- Google Maps Places for Add Company modal (uses same style as companies.html) -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places"
  async defer>
</script>

<style>
  .progress-bar { transition: width 1s ease-in-out; }
  .card { transition: transform 0.2s ease; }
  .list-group-item:hover { background-color: #fcfcfc; }
  .badge { letter-spacing: 0.5px; }
</style>

{% endblock %}
