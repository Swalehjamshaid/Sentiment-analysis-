{# File: review_saas/app/templates/dashboard.html #}
{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h3 class="mb-0">Review Intelligence Dashboard</h3>

    <div class="d-flex align-items-center gap-3 flex-wrap">
      <!-- Company Selector -->
      <select id="company-selector" class="form-select" style="min-width: 260px;">
        <option value="0">Select a Company...</option>
      </select>

      <!-- Months Selector -->
      <select id="months-selector" class="form-select" style="min-width: 140px;">
        <option value="3">Last 3 months</option>
        <option value="6" selected>Last 6 months</option>
        <option value="9">Last 9 months</option>
        <option value="12">Last 12 months</option>
      </select>

      <button id="apply-range-btn" class="btn btn-outline-primary">
        <i class="bi bi-funnel"></i> Apply Range
      </button>

      <button id="refresh-btn" class="btn btn-outline-success">
        <i class="bi bi-arrow-repeat"></i> Refresh & Fetch Latest
      </button>
    </div>
  </div>

  <!-- Company Header -->
  <div class="card shadow mb-4 border-0" id="company-header" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h4 id="company-name" class="mb-1">Company Name</h4>
          <div class="text-muted small">
            <span>Google Rating: <strong id="google-rating">—</strong></span> •
            <span>Total Ratings: <strong id="google-total-ratings">—</strong></span>
          </div>
        </div>

        <div class="text-end small">
          <div class="text-muted">
            Date Window: <span id="date-window">21 Feb 2026 → Today</span>
          </div>
          <div class="text-muted">
            Months: <span id="months-active">6</span>
            • Last refreshed: <span id="last-refresh">—</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading / Status Messages -->
  <div id="loading-state" class="text-center py-5 my-5" style="display: none;">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;" role="status"></div>
    <p class="lead text-muted">Fetching latest reviews and analytics... (may take up to 40 seconds)</p>
    <small class="text-muted">Please wait while we pull data from Google and process insights.</small>
  </div>

  <div id="no-selection-state" class="alert alert-info text-center py-5 my-5">
    <i class="bi bi-building fs-1 mb-3 d-block"></i>
    <h5>Select a company to view deep analysis</h5>
    <p class="text-muted">Click on any company from the dropdown to see reviews, trends, keywords, weak areas, AI recommendations, and actions.</p>
  </div>

  <!-- Main Dashboard Content -->
  <div id="main-content" style="display: none;">
    <!-- KPI Cards (Total Reviews, Avg Rating, Sentiment, Risk) -->
    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-3">Total Reviews</h6>
            <h2 id="total-reviews" class="display-6 fw-bold">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-3">Average Rating</h6>
            <h2 id="avg-rating" class="display-6 fw-bold">0.0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-2">Sentiment Mix</h6>
            <h3 id="sentiment-mix" class="fw-bold mb-2">0 / 0 / 0</h3>
            <div class="mt-1">
              <span class="badge bg-success me-2">Positive</span>
              <span class="badge bg-warning me-2">Neutral</span>
              <span class="badge bg-danger">Negative</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-2">Risk Score</h6>
            <div style="height: 90px;">
              <canvas id="riskGauge"></canvas>
            </div>
            <div class="mt-2">
              <span id="risk-score-text" class="badge bg-secondary">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Decision Insights & Data Completion -->
    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h5 class="card-title mb-3">AI Recommended Improvement Plan</h5>
            <div id="ai-recs" class="list-group list-group-flush"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body">
            <h6 class="card-title mb-3">Data Completion</h6>
            <div class="progress" style="height: 18px;">
              <div id="data-completion-bar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
            </div>
            <small class="text-muted d-block mt-2">Percentage of reviews captured vs Google total.</small>

            <hr>
            <h6 class="card-title">Top Weak Areas</h6>
            <div id="weak-areas-chips" class="d-flex flex-wrap gap-2 mt-2"></div>

            <hr>
            <h6 class="card-title">Top Strength Areas</h6>
            <div id="strength-areas-chips" class="d-flex flex-wrap gap-2 mt-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4">
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Rating Trend & Volume</h5>
            <div style="height: 360px;">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-3">Sentiment Distribution</h5>
            <div style="height: 320px;">
              <canvas id="sentimentPie"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Weak Areas (Top Negative Keywords)</h5>
            <div style="height: 280px;">
              <canvas id="weakAreasChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Strength Areas (Top Positive Keywords)</h5>
            <div style="height: 280px;">
              <canvas id="strengthAreasChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title">Quick Actions</h5>
            <a href="/companies" class="btn btn-outline-primary d-block mb-2">
              <i class="bi bi-building-add"></i> Manage Companies
            </a>
            <button class="btn btn-outline-info d-block w-100" disabled>
              <i class="bi bi-file-earmark-pdf"></i> Export PDF Report (soon)
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Keywords Cloud -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Top Keywords</h5>
        <div id="keywords-cloud" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- Recent Reviews -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">Recent Reviews & Auto-generated Replies</h5>
      </div>
      <div class="card-body p-0">
        <div id="reviews-container" class="list-group list-group-flush"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const FILE_NAME_HTML = "review_saas/app/templates/dashboard.html";
let trendChart, sentimentPieChart, weakAreasChart, strengthAreasChart, riskGaugeChart;
let currentCompanyId = 0;
let isFetching = false;
let activeMonths = 6;

const colors = { primary:'#0d6efd', primaryFill:'rgba(13,110,253,0.15)', success:'#28a745', warning:'#ffc107', danger:'#dc3545', gray:'#6c757d', light:'#e9ecef' };
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

function updateDateWindowDisplay(){
  const start=new Date(Date.UTC(2026,1,21)), end=new Date();
  const fmt=d=>d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  document.getElementById('date-window').textContent=`${fmt(start)} → ${fmt(end)}`;
}

// ── Load companies from /companies/list ──
async function loadCompanies() {
  try{
    const res = await fetch('/companies/list');
    if(!res.ok) throw new Error('Failed to load companies');
    const companies = await res.json();
    const select=document.getElementById('company-selector');
    select.innerHTML='<option value="0">Select a Company...</option>';
    companies.forEach(c=>{
      const opt=document.createElement('option');
      opt.value=c.id; opt.textContent=c.name; select.appendChild(opt);
    });
    if(companies.length>0){currentCompanyId=companies[0].id; select.value=currentCompanyId; await loadDashboardData(currentCompanyId);}
    select.addEventListener('change', async e=>{
      currentCompanyId=parseInt(e.target.value);
      currentCompanyId>0 ? await loadDashboardData(currentCompanyId,false) : showNoSelection();
    });
  }catch(err){console.error(`[${FILE_NAME_HTML}] Companies load error:`, err);}
}

// ── Load dashboard summary / charts ──
async function loadDashboardData(companyId, forceRefresh=false){
  if(!companyId) return showNoSelection();
  if(isFetching) return;
  isFetching=true;
  document.getElementById('loading-state').style.display='block';
  document.getElementById('no-selection-state').style.display='none';
  document.getElementById('main-content').style.display='none';
  try{
    const qs=new URLSearchParams();
    if(forceRefresh) qs.set('refresh','true');
    if(activeMonths>0) qs.set('months',String(activeMonths));
    const url=`/reviews/summary/${companyId}${qs.toString()?'?'+qs.toString():''}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data=await res.json();

    document.getElementById('loading-state').style.display='none';
    document.getElementById('main-content').style.display='block';
    document.getElementById('company-header').style.display='block';

    document.getElementById('company-name').textContent=data.company_name||'Company';
    document.getElementById('google-rating').textContent=data.google_rating ?? '—';
    document.getElementById('google-total-ratings').textContent=data.google_total_ratings ?? '—';
    document.getElementById('last-refresh').textContent=new Date().toLocaleString();
    document.getElementById('months-active').textContent=activeMonths;

    document.getElementById('total-reviews').textContent=data.total_reviews||0;
    document.getElementById('avg-rating').textContent=(data.avg_rating||0).toFixed(1);
    document.getElementById('sentiment-mix').textContent=`${data.sentiments?.Positive||0} / ${data.sentiments?.Neutral||0} / ${data.sentiments?.Negative||0}`;

    // Data completion
    const completion=clamp(Number(data.data_completion_percent||0),0,100);
    const bar=document.getElementById('data-completion-bar');
    bar.style.width=`${completion}%`; bar.textContent=`${completion}%`;
    bar.className='progress-bar '+(completion>=75?'bg-success':completion>=40?'bg-warning':'bg-danger');

    // Chips
    makeChips('weak-areas-chips',data.weak_areas||[],'danger');
    makeChips('strength-areas-chips',data.strength_areas||[],'success');

    // Keywords Cloud
    const keywordsDiv=document.getElementById('keywords-cloud'); keywordsDiv.innerHTML='';
    const allKeywords=[...(data.positive_keywords||[]),...(data.negative_keywords||[])];
    if(allKeywords.length===0) keywordsDiv.innerHTML='<span class="text-muted">No keywords detected yet</span>';
    else allKeywords.forEach(kw=>{ const tag=document.createElement('span'); tag.className='badge bg-light text-dark border px-3 py-2'; tag.textContent=kw; keywordsDiv.appendChild(tag); });

    // Reviews
    const reviewsContainer=document.getElementById('reviews-container'); reviewsContainer.innerHTML='';
    if(!data.reviews||data.reviews.length===0) reviewsContainer.innerHTML='<div class="list-group-item text-center text-muted py-5">No reviews available.</div>';
    else{
      data.reviews.slice(0,10).forEach(review=>{
        const item=document.createElement('div'); item.className='list-group-item px-4 py-3';
        item.innerHTML=`
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div><h6 class="mb-1">${review.reviewer_name||'Anonymous'}</h6><small class="text-muted">${review.review_date||'—'}</small></div>
            <div class="text-end"><span class="badge fs-6 px-3 py-2 ${review.sentiment==='Positive'?'bg-success':review.sentiment==='Negative'?'bg-danger':'bg-warning'}">${review.rating??'—'} ★ • ${review.sentiment}</span></div>
          </div>
          <p class="mb-3">${(review.review_text||'').substring(0,220)}${(review.review_text||'').length>220?'...':''}</p>
          <div class="border-top pt-3 mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong class="text-muted small">Suggested Reply:</strong>
              <button class="btn btn-sm btn-outline-secondary copy-reply-btn" data-reply="${(review.suggested_reply||'Thank you for your feedback!').replace(/"/g,'&quot;')}"><i class="bi bi-clipboard"></i> Copy</button>
            </div>
            <div class="bg-light p-3 rounded small">${review.suggested_reply||'No reply suggestion available'}</div>
          </div>
        `;
        reviewsContainer.appendChild(item);
      });
      document.querySelectorAll('.copy-reply-btn').forEach(btn=>{
        btn.addEventListener('click',function(){ navigator.clipboard.writeText(this.dataset.reply); const orig=this.innerHTML; this.innerHTML='<i class="bi bi-check2"></i> Copied!'; this.disabled=true; setTimeout(()=>{ this.innerHTML=orig; this.disabled=false; },1800); });
      });
    }

    // Charts
    renderTrendChart(data); renderSentimentPie(data); renderWeakAreasChart(data); renderStrengthAreasChart(data); renderRiskGauge(data);
    renderAIRecommendations(data);

  }catch(err){console.error(`[${FILE_NAME_HTML}] Dashboard load error:`, err);}
  finally{isFetching=false; document.getElementById('loading-state').style.display='none';}
}

function makeChips(containerId, arr, kind='secondary'){ const div=document.getElementById(containerId); div.innerHTML=''; if(!arr||arr.length===0){ div.innerHTML='<span class="text-muted">No data</span>'; return; } arr.slice(0,10).forEach(item=>{ const chip=document.createElement('span'); chip.className=`badge bg-${kind}`; chip.textContent=`
