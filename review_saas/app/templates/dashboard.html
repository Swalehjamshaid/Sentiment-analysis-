{% extends 'base.html' %}
{% block content %}

<div class="container mt-4">

  <!-- Low data warning (critical in 2026 with Places API limitation) -->
  <div id="low-data-warning" class="alert alert-warning d-none mb-4" role="alert">
    <i class="bi bi-exclamation-triangle-fill me-2"></i>
    <strong>Limited review data loaded.</strong> 
    Only a small number of reviews are available (likely due to Google Places API restrictions — max ~5 reviews). 
    For accurate insights, enable full Google Business Profile sync.
  </div>

  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h3 class="mb-0">Review Intelligence Dashboard</h3>
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <select id="company-selector" class="form-select" style="min-width: 260px;" aria-label="Select company">
        <option value="0">Select a Company...</option>
      </select>
      <button id="add-company-btn" class="btn btn-outline-dark" aria-label="Add new company">
        <i class="bi bi-building-add"></i> Add Company
      </button>
      <div class="d-flex align-items-center gap-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
          <input id="date-from" type="date" class="form-control" aria-label="From date" />
        </div>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-calendar-date-fill"></i></span>
          <input id="date-to" type="date" class="form-control" aria-label="To date" />
        </div>
      </div>
      <button id="apply-range-btn" class="btn btn-outline-primary">
        <i class="bi bi-funnel"></i> Apply
      </button>
      <button id="refresh-btn" class="btn btn-outline-success">
        <i class="bi bi-arrow-repeat"></i> Refresh & Fetch
      </button>
      <button id="owner-summary-btn" class="btn btn-primary" disabled aria-label="Owner summary">
        <i class="bi bi-stars"></i> Owner Summary
      </button>
    </div>
  </div>

  <div class="card shadow mb-4 border-0" id="company-header" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <h4 id="company-name" class="mb-1 text-primary"></h4>
          <div class="text-muted small">
            <span>Google Rating: <strong id="google-rating">—</strong></span> •
            <span>Total Ratings: <strong id="google-total-ratings">—</strong></span>
          </div>
        </div>
        <div class="text-end small">
          <div class="text-muted">
            Window: <span id="date-window" class="fw-bold text-dark"></span>
          </div>
          <div class="text-muted">
            Sync: <span id="last-refresh" class="text-success">—</span>
          </div>
        </div>
      </div>
      <div id="executive-summary-line" class="text-muted small mt-2" style="display:none;">
        <i class="bi bi-info-circle"></i> <span id="executive-summary-text"></span>
      </div>
    </div>
  </div>

  <div id="loading-state" class="text-center py-5 my-5" style="display: none;">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;" role="status"></div>
    <p class="lead text-muted">Analyzing reviews & generating insights…</p>
    <small class="text-muted">This may take 5–30 seconds depending on data volume</small>
  </div>

  <div id="no-selection-state" class="alert alert-light border text-center py-5 my-5 shadow-sm">
    <i class="bi bi-building-up fs-1 mb-3 d-block text-primary"></i>
    <h5>Review Intelligence Dashboard</h5>
    <p class="text-muted">Select a company and date range to view AI-powered insights.</p>
  </div>

  <div id="main-content" style="display: none;">

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-primary border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-3">Total Reviews</h6>
            <h2 id="total-reviews" class="display-6 fw-bold">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-success border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-3">Average Rating</h6>
            <h2 id="avg-rating" class="display-6 fw-bold">0.0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-warning border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-2">Sentiment Mix</h6>
            <h3 id="sentiment-mix" class="fw-bold mb-2">0 / 0 / 0</h3>
            <div class="mt-1">
              <span class="badge bg-success-subtle text-success border border-success me-1">Pos</span>
              <span class="badge bg-warning-subtle text-warning border border-warning me-1">Neu</span>
              <span class="badge bg-danger-subtle text-danger border border-danger">Neg</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm border-0 h-100 border-start border-danger border-4">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted small mb-2">Risk Score</h6>
            <div style="height: 60px;">
              <canvas id="riskGauge"></canvas>
            </div>
            <div class="mt-2">
              <span id="risk-score-text" class="badge rounded-pill px-4">0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- The rest of your layout remains almost identical -->

    <!-- Keep all other sections: AI plan, data accuracy, charts, keywords, reviews list, etc. -->

    <!-- ... paste your existing row g-4 mb-4 with AI recs, data accuracy, charts ... -->

  </div>
</div>

<!-- Add Company Modal (unchanged except improved labels) -->
<div class="modal fade" id="addCompanyModal" tabindex="-1" aria-labelledby="addCompanyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="add-company-form" class="modal-content" autocomplete="off">
      <!-- ... your existing modal content ... -->
    </form>
  </div>
</div>

<!-- Libraries -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ─────────────────────────────────────────────────────────────
// JavaScript (refined)
// ─────────────────────────────────────────────────────────────

const FILE_NAME_HTML = "review_saas/app/templates/dashboard.html";

let trendChart, sentimentPieChart, weakAreasChart, strengthAreasChart, riskGaugeChart, aspectMatrixChart;
let currentCompanyId = 0;
let isFetching = false;
let lastSummaryData = null;
let addCoPlacesAutocomplete = null;

const colors = {
  primary: '#0d6efd',
  success: '#198754',
  warning: '#ffc107',
  danger: '#dc3545',
  gray: '#6c757d',
  light: '#f8f9fa'
};

document.addEventListener('DOMContentLoaded', () => {
  initDefaultDates();
  updateDateWindowDisplay();
  loadCompanies();

  document.getElementById('apply-range-btn').addEventListener('click', () => {
    if (currentCompanyId > 0) loadDashboardData(currentCompanyId, false);
  });

  document.getElementById('refresh-btn').addEventListener('click', () => {
    if (currentCompanyId > 0) loadDashboardData(currentCompanyId, true);
  });

  // Owner summary modal trigger (requires modal HTML to exist)
  document.getElementById('owner-summary-btn').addEventListener('click', () => {
    if (!lastSummaryData) return;
    populateOwnerSummaryModal(lastSummaryData);
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('ownerSummaryModal'));
    modal.show();
  });

  // Add company modal
  document.getElementById('add-company-btn').addEventListener('click', () => {
    clearAddCompanyForm();
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addCompanyModal'));
    modal.show();

    if (!addCoPlacesAutocomplete && window.google?.maps?.places) {
      addCoPlacesAutocomplete = new google.maps.places.Autocomplete(
        document.getElementById('addco_google_search'),
        { types: ['establishment'] }
      );
      addCoPlacesAutocomplete.addListener('place_changed', handleAddCoPlacePicked);
    }
  });

  document.getElementById('add-company-form').addEventListener('submit', async e => {
    e.preventDefault();
    await submitNewCompany();
  });

  document.getElementById('date-from').addEventListener('change', updateDateWindowDisplay);
  document.getElementById('date-to').addEventListener('change', updateDateWindowDisplay);
});

function initDefaultDates() {
  const df = new Date(Date.UTC(2026, 1, 21));
  const dt = new Date();
  const fmt = d => d.toISOString().slice(0, 10);
  document.getElementById('date-from').value = fmt(df);
  document.getElementById('date-to').value = fmt(dt);
}

// ── Core fetch & render logic ─────────────────────────────────

async function loadDashboardData(companyId, forceRefresh = false) {
  if (isFetching) return;
  isFetching = true;

  document.getElementById('loading-state').style.display = 'block';
  document.getElementById('no-selection-state').style.display = 'none';
  document.getElementById('main-content').style.display = 'none';
  document.getElementById('company-header').style.display = 'none';
  document.getElementById('owner-summary-btn').disabled = true;
  document.getElementById('executive-summary-line').style.display = 'none';
  document.getElementById('low-data-warning').classList.add('d-none');

  try {
    const { date_from, date_to } = getDateInputs();
    updateDateWindowDisplay();

    const qp = new URLSearchParams();
    if (date_from) qp.set('date_from', date_from);
    if (date_to) qp.set('date_to', date_to);
    qp.set('refresh', String(!!forceRefresh));

    const res = await fetch(`/reviews/summary/${companyId}?${qp}`);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    lastSummaryData = data;

    // Populate header
    document.getElementById('company-name').textContent = data.company_name || '—';
    document.getElementById('google-rating').textContent = data.google_rating ?? '—';
    document.getElementById('google-total-ratings').textContent = data.google_total_ratings ?? '—';

    document.getElementById('total-reviews').textContent = data.total_reviews ?? 0;
    document.getElementById('avg-rating').textContent = (data.avg_rating ?? 0).toFixed(1);
    document.getElementById('sentiment-mix').textContent =
      `${data.sentiments?.Positive ?? 0} / ${data.sentiments?.Neutral ?? 0} / ${data.sentiments?.Negative ?? 0}`;

    document.getElementById('last-refresh').textContent = forceRefresh ? 'Just now' : 'Synced';

    if (data.executive_summary) {
      document.getElementById('executive-summary-text').textContent = data.executive_summary;
      document.getElementById('executive-summary-line').style.display = 'block';
    }

    // Data completion & warning
    const completion = computeCompletionPercent(data);
    const bar = document.getElementById('data-completion-bar');
    bar.style.width = `${completion}%`;
    document.getElementById('data-completion-text').textContent = `${completion}%`;

    bar.className = 'progress-bar ' + (
      completion >= 80 ? 'bg-success' :
      completion >= 50 ? 'bg-warning' :
      'bg-danger'
    );

    if (completion < 40) {
      document.getElementById('low-data-warning').classList.remove('d-none');
    }

    // Render rest
    renderChips('weak-areas-chips', data.weak_areas || [], 'danger');
    renderChips('strength-areas-chips', data.strength_areas || [], 'success');
    renderKeywordsCloud(data.positive_keywords || [], data.negative_keywords || []);
    renderTopNegativePhrases(data.top_phrases_negative || []);
    renderAIRecommendations(data.ai_recommendations || []);
    renderReviews(data.reviews || []);

    initCharts(data);

    document.getElementById('owner-summary-btn').disabled = false;
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('company-header').style.display = 'block';

  } catch (err) {
    console.error(`[${FILE_NAME_HTML}]`, err);
    alert("Failed to load dashboard data. Check console or server logs.");
  } finally {
    isFetching = false;
    document.getElementById('loading-state').style.display = 'none';
  }
}

// Keep your existing helper functions: computeCompletionPercent, renderChips, renderTopNegativePhrases,
// renderKeywordsCloud, renderAIRecommendations, renderReviews, copyText, initCharts, showNoSelection,
// clearAddCompanyForm, handleAddCoPlacePicked, showAddCoError, submitNewCompany, reloadCompanyDropdownAndSelectNew,
// populateOwnerSummaryModal, buildOwnerSummaryClipboardText

// (They are already well written — no major changes needed there)

</script>

<!-- Google Places script (replace YOUR_GOOGLE_API_KEY) -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_API_KEY&libraries=places"></script>

<style>
  .card {
    transition: transform 0.18s ease, box-shadow 0.18s ease;
  }
  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.08);
  }
  .progress-bar {
    transition: width 1.2s ease-in-out;
  }
  .alert-warning {
    transition: opacity 0.4s ease;
  }
  .badge {
    letter-spacing: 0.4px;
    font-weight: 500;
  }
</style>

{% endblock %}
