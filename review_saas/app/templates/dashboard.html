<!-- FILE: review_saas/app/templates/dashboard.html -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Review Intelligence Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background:#f4f6f9; }
.card { border:none; border-radius:14px; box-shadow:0 2px 12px rgba(0,0,0,0.05); }
.metric { font-size:28px; font-weight:700; }
.badge-risk-low { background:#28a745; }
.badge-risk-medium { background:#ffc107; color:#000; }
.badge-risk-high { background:#dc3545; }
.navbar-brand { font-weight:600; }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand">Review Intelligence Dashboard</span>
    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCompanyModal">
      + Add Company
    </button>
  </div>
</nav>

<div class="container">

  <!-- Company Selector -->
  <div class="card p-3 mb-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <label class="form-label">Select Company</label>
        <select id="companySelect" class="form-select"></select>
      </div>
      <div class="col-md-6 text-end mt-3 mt-md-0">
        <button class="btn btn-primary" onclick="syncReviews()">Sync Reviews</button>
        <button class="btn btn-outline-dark" onclick="openOwnerSummary()">AI Owner Summary</button>
      </div>
    </div>
  </div>

  <!-- Metrics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Total Reviews</div>
        <div id="metricTotal" class="metric">0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Average Rating</div>
        <div id="metricAvg" class="metric">0.0</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Risk Score</div>
        <div id="metricRisk" class="metric">0%</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div>Risk Level</div>
        <span id="riskBadge" class="badge badge-risk-low">Low</span>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Trend</h6>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h6>Sentiment</h6>
        <canvas id="sentimentChart"></canvas>
      </div>
    </div>
  </div>

  <!-- AI Recommendations -->
  <div class="card p-3 mb-4">
    <h6>AI Action Recommendations</h6>
    <div id="recommendations"></div>
  </div>

</div>

<!-- Add Company Modal -->
<div class="modal fade" id="addCompanyModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5>Add New Company</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="placeQuery" class="form-control mb-2" placeholder="Search business name">
        <button class="btn btn-primary w-100" onclick="searchPlace()">Search via Google</button>
        <div id="searchResults" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- Owner Summary Modal -->
<div class="modal fade" id="ownerSummaryModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5>AI Owner Summary</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="owner-summary-content"></div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="copySummary()">Copy</button>
      </div>
    </div>
  </div>
</div>

<script>
let currentCompany = null;
let trendChart, sentimentChart;
let currentSummaryData = null;

async function loadCompanies() {
  const res = await fetch('/companies');
  const companies = await res.json();

  const select = document.getElementById('companySelect');
  select.innerHTML = '';

  companies.forEach(c => {
    const option = document.createElement('option');
    option.value = c.id;
    option.textContent = c.name;
    select.appendChild(option);
  });

  if (companies.length) {
    currentCompany = companies[0].id;
    loadSummary();
  }

  select.onchange = () => {
    currentCompany = select.value;
    loadSummary();
  };
}

async function loadSummary() {
  if (!currentCompany) return;
  const res = await fetch(`/reviews/summary/${currentCompany}`);
  const data = await res.json();
  currentSummaryData = data;

  document.getElementById('metricTotal').innerText = data.total_reviews;
  document.getElementById('metricAvg').innerText = data.avg_rating;
  document.getElementById('metricRisk').innerText = data.risk_score + '%';

  const badge = document.getElementById('riskBadge');
  badge.className = 'badge';
  if (data.risk_level === 'High') badge.classList.add('badge-risk-high');
  else if (data.risk_level === 'Medium') badge.classList.add('badge-risk-medium');
  else badge.classList.add('badge-risk-low');
  badge.innerText = data.risk_level;

  renderCharts(data);
  renderRecommendations(data.ai_recommendations);
}

function renderCharts(data) {
  const trendLabels = data.trend_data.map(t => t.month);
  const trendValues = data.trend_data.map(t => t.avg_rating);

  if (trendChart) trendChart.destroy();
  trendChart = new Chart(document.getElementById('trendChart'), {
    type:'line',
    data:{ labels:trendLabels, datasets:[{ label:'Avg Rating', data:trendValues, borderColor:'#007bff' }] }
  });

  if (sentimentChart) sentimentChart.destroy();
  sentimentChart = new Chart(document.getElementById('sentimentChart'), {
    type:'doughnut',
    data:{
      labels:['Positive','Neutral','Negative'],
      datasets:[{ data:[
        data.sentiments.Positive,
        data.sentiments.Neutral,
        data.sentiments.Negative
      ]}]
    }
  });
}

function renderRecommendations(list) {
  const container = document.getElementById('recommendations');
  container.innerHTML = '';
  list.forEach(r => {
    container.innerHTML += `
      <div class="border rounded p-2 mb-2">
        <strong>${r.area}</strong> (${r.priority})<br>
        ${r.action}
      </div>`;
  });
}

async function syncReviews() {
  await fetch(`/reviews/sync/${currentCompany}`);
  loadSummary();
}

function openOwnerSummary() {
  const container = document.getElementById('owner-summary-content');
  const data = currentSummaryData;
  if (!data) return;

  container.innerHTML = `
    <h5>Executive Overview</h5>
    <p>${data.total_reviews} reviews analysed. Average rating ${data.avg_rating}. Risk ${data.risk_score}%.</p>
    <h5 class="mt-3">Action Plan</h5>
    <ul>
      ${data.ai_recommendations.map(r=>`<li><strong>${r.area}</strong>: ${r.action}</li>`).join('')}
    </ul>
  `;

  new bootstrap.Modal(document.getElementById('ownerSummaryModal')).show();
}

function copySummary() {
  const text = document.getElementById('owner-summary-content').innerText;
  navigator.clipboard.writeText(text);
}

loadCompanies();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
