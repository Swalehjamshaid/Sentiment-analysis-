{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <h3>Review Intelligence Dashboard</h3>

    <div class="d-flex align-items-center gap-3">
      <select id="company-selector" class="form-select" style="min-width: 260px;">
        <option value="0">Select a Company...</option>
      </select>

      <button id="refresh-btn" class="btn btn-outline-success">
        <i class="bi bi-arrow-repeat"></i> Refresh & Fetch Latest
      </button>
    </div>
  </div>

  <!-- Company Header -->
  <div class="card shadow mb-4 border-0" id="company-header" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 id="company-name">Company Name</h4>
          <div class="text-muted small">
            <span>Google Rating: <strong id="google-rating">—</strong></span> •
            <span>Total Ratings: <strong id="google-total-ratings">—</strong></span>
          </div>
        </div>
        <small class="text-muted">Last refreshed: <span id="last-refresh">—</span></small>
      </div>
    </div>
  </div>

  <!-- Loading / Status Messages -->
  <div id="loading-state" class="text-center py-5 my-5" style="display: none;">
    <div class="spinner-border text-primary mb-3" style="width: 3.5rem; height: 3.5rem;" role="status"></div>
    <p class="lead text-muted">Fetching latest reviews and analytics... (may take up to 40 seconds)</p>
    <small class="text-muted">Please wait while we pull data from Google and process insights.</small>
  </div>

  <div id="no-selection-state" class="alert alert-info text-center py-5 my-5">
    <i class="bi bi-building fs-1 mb-3 d-block"></i>
    <h5>Select a company to view deep analysis</h5>
    <p class="text-muted">Click on any company from the dropdown to see reviews, trends, keywords, weak areas, and suggested actions.</p>
  </div>

  <!-- Main Dashboard Content -->
  <div id="main-content" style="display: none;">
    <!-- KPI Cards -->
    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-3">Total Reviews</h6>
            <h2 id="total-reviews" class="display-5 fw-bold">0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-3">Average Rating</h6>
            <h2 id="avg-rating" class="display-5 fw-bold">0.0</h2>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h6 class="text-uppercase text-muted mb-3">Sentiment Mix</h6>
            <h3 id="sentiment-mix" class="fw-bold">0 / 0 / 0</h3>
            <div class="mt-2">
              <span class="badge bg-success me-2">Positive</span>
              <span class="badge bg-warning me-2">Neutral</span>
              <span class="badge bg-danger">Negative</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top 3 Weak Areas & Recommendations -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">
        <h5 class="card-title mb-4">Top 3 Graphs & Weak Areas Overview</h5>
        <div class="row g-4">
          <div class="col-md-4">
            <h6>1. Low Rating Products/Services</h6>
            <canvas id="weakArea1Chart" style="height: 180px;"></canvas>
            <small class="text-muted d-block mt-2" id="weakArea1Action">—</small>
          </div>
          <div class="col-md-4">
            <h6>2. Negative Sentiment Drivers</h6>
            <canvas id="weakArea2Chart" style="height: 180px;"></canvas>
            <small class="text-muted d-block mt-2" id="weakArea2Action">—</small>
          </div>
          <div class="col-md-4">
            <h6>3. Repeated Complaints / Keywords</h6>
            <canvas id="weakArea3Chart" style="height: 180px;"></canvas>
            <small class="text-muted d-block mt-2" id="weakArea3Action">—</small>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Main Charts -->
      <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title mb-4">Rating Trend Over Time</h5>
            <div style="height: 320px;">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-4">Sentiment Distribution</h5>
            <div style="height: 320px;">
              <canvas id="sentimentPie"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h5 class="card-title">Quick Actions</h5>
            <a href="/companies" class="btn btn-outline-primary d-block mb-2">
              <i class="bi bi-building-add"></i> Manage Companies
            </a>
            <button class="btn btn-outline-info d-block w-100" disabled>
              <i class="bi bi-file-earmark-pdf"></i> Export PDF Report (soon)
            </button>
          </div>
        </div>

        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h6 class="card-title">Top Keywords</h6>
            <div id="keywords-cloud" class="d-flex flex-wrap gap-2 mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Reviews & Suggested Replies -->
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">Recent Reviews & Auto-generated Replies</h5>
      </div>
      <div class="card-body p-0">
        <div id="reviews-container" class="list-group list-group-flush"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ── Global Variables ─────────────────────────────────────────────
let trendChart = null;
let sentimentPieChart = null;
let weakAreaCharts = [];
let currentCompanyId = {{ current_company_id | default(0) }};
let isFetching = false;

// ── Load companies list ────────────────────────────────────────────
async function loadCompanies() {
  try {
    const response = await fetch('/reviews/my-companies');
    if (!response.ok) throw new Error('Failed to load companies');
    const companies = await response.json();

    const select = document.getElementById('company-selector');
    select.innerHTML = '<option value="0">Select a Company...</option>';

    companies.forEach(company => {
      const option = document.createElement('option');
      option.value = company.id;
      option.textContent = company.name;
      if (company.id == currentCompanyId) option.selected = true;
      select.appendChild(option);
    });

    if (currentCompanyId === 0 && companies.length > 0) {
      currentCompanyId = companies[0].id;
      select.value = currentCompanyId;
      await loadDashboardData(currentCompanyId);
    }

    select.addEventListener('change', async (e) => {
      currentCompanyId = parseInt(e.target.value);
      if (currentCompanyId > 0) {
        await loadDashboardData(currentCompanyId, false);
      } else showNoSelection();
    });
  } catch (error) {
    console.error('Companies load error:', error);
  }
}

// ── Load dashboard data ─────────────────────────────────────────────
async function loadDashboardData(companyId, forceRefresh = false) {
  if (!companyId) return showNoSelection();
  if (isFetching) return;
  isFetching = true;

  document.getElementById('loading-state').style.display = 'block';
  document.getElementById('no-selection-state').style.display = 'none';
  document.getElementById('main-content').style.display = 'none';

  try {
    const url = `/reviews/summary/${companyId}${forceRefresh ? '?refresh=true' : ''}`;
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();

    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('main-content').style.display = 'block';
    document.getElementById('company-header').style.display = 'block';

    document.getElementById('company-name').textContent = data.company_name || 'Company';
    document.getElementById('google-rating').textContent = data.google_rating || '—';
    document.getElementById('google-total-ratings').textContent = data.google_total_ratings || '—';
    document.getElementById('last-refresh').textContent = new Date().toLocaleString();

    document.getElementById('total-reviews').textContent = data.total_reviews || 0;
    document.getElementById('avg-rating').textContent = (data.avg_rating || 0).toFixed(1);
    document.getElementById('sentiment-mix').textContent =
      `${data.sentiments?.Positive || 0} / ${data.sentiments?.Neutral || 0} / ${data.sentiments?.Negative || 0}`;

    // Keywords
    const keywordsDiv = document.getElementById('keywords-cloud');
    keywordsDiv.innerHTML = '';
    const allKeywords = [...(data.positive_keywords || []), ...(data.negative_keywords || [])];
    if (allKeywords.length === 0) keywordsDiv.innerHTML = '<span class="text-muted">No keywords detected yet</span>';
    else allKeywords.forEach(kw => {
      const tag = document.createElement('span');
      tag.className = 'badge bg-light text-dark border px-3 py-2';
      tag.textContent = kw;
      keywordsDiv.appendChild(tag);
    });

    // Reviews
    const reviewsContainer = document.getElementById('reviews-container');
    reviewsContainer.innerHTML = '';
    if (!data.reviews || data.reviews.length === 0) {
      reviewsContainer.innerHTML = '<div class="list-group-item text-center text-muted py-5">No reviews available.</div>';
    } else {
      data.reviews.slice(0, 10).forEach(review => {
        const item = document.createElement('div');
        item.className = 'list-group-item px-4 py-3';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-1">${review.reviewer_name || 'Anonymous'}</h6>
              <small class="text-muted">${review.review_date || '—'}</small>
            </div>
            <div class="text-end">
              <span class="badge fs-6 px-3 py-2 ${
                review.sentiment === 'Positive' ? 'bg-success' :
                review.sentiment === 'Negative' ? 'bg-danger' : 'bg-warning'
              }">
                ${review.rating} ★ • ${review.sentiment}
              </span>
            </div>
          </div>
          <p class="mb-3">${review.review_text.substring(0, 220)}${review.review_text.length > 220 ? '...' : ''}</p>
          <div class="border-top pt-3 mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong class="text-muted small">Suggested Reply:</strong>
              <button class="btn btn-sm btn-outline-secondary copy-reply-btn"
                      data-reply="${review.suggested_reply || 'Thank you for your feedback!'}">
                <i class="bi bi-clipboard"></i> Copy
              </button>
            </div>
            <div class="bg-light p-3 rounded small">
              ${review.suggested_reply || 'No reply suggestion available'}
            </div>
          </div>
        `;
        reviewsContainer.appendChild(item);
      });
      document.querySelectorAll('.copy-reply-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          navigator.clipboard.writeText(this.dataset.reply);
          const original = this.innerHTML;
          this.innerHTML = '<i class="bi bi-check2"></i> Copied!';
          this.disabled = true;
          setTimeout(() => { this.innerHTML = original; this.disabled = false; }, 2000);
        });
      });
    }

    // Charts
    renderTrendChart(data);
    renderSentimentPie(data);
    renderWeakAreas(data);

  } catch (err) {
    console.error('Dashboard load error:', err);
  } finally {
    isFetching = false;
    document.getElementById('loading-state').style.display = 'none';
  }
}

// ── Charts ─────────────────────────────────────────────
function renderTrendChart(data) {
  const ctx = document.getElementById('trendChart').getContext('2d');
  if (trendChart) trendChart.destroy();
  const labels = data.trend_data?.map(i => i.month) || [];
  const values = data.trend_data?.map(i => i.avg_rating) || [];
  trendChart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: 'Average Rating', data: values.length ? values : [0], borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253,0.15)', tension: 0.3, fill:true }] },
    options: { responsive: true, maintainAspectRatio: false, scales:{y:{min:0,max:5.5}} }
  });
}

function renderSentimentPie(data) {
  const ctx = document.getElementById('sentimentPie').getContext('2d');
  if (sentimentPieChart) sentimentPieChart.destroy();
  const pos = data.sentiments?.Positive||0, neu=data.sentiments?.Neutral||0, neg=data.sentiments?.Negative||0;
  sentimentPieChart = new Chart(ctx, { type:'pie', data:{labels:['Positive','Neutral','Negative'], datasets:[{data:[pos,neu,neg],backgroundColor:['#28a745','#ffc107','#dc3545'],borderColor:'#fff',borderWidth:2}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}}});
}

function renderWeakAreas(data) {
  const areas = [
    {chartId:'weakArea1Chart', values:data.weak_areas?.low_rating || [], actionId:'weakArea1Action', action:data.weak_areas?.low_rating_action || '—'},
    {chartId:'weakArea2Chart', values:data.weak_areas?.negative_drivers || [], actionId:'weakArea2Action', action:data.weak_areas?.negative_drivers_action || '—'},
    {chartId:'weakArea3Chart', values:data.weak_areas?.repeated_keywords || [], actionId:'weakArea3Action', action:data.weak_areas?.repeated_keywords_action || '—'}
  ];

  weakAreaCharts.forEach(c=>c.destroy());
  weakAreaCharts=[];

  areas.forEach(a=>{
    const ctx=document.getElementById(a.chartId).getContext('2d');
    const chart=new Chart(ctx,{
      type:'bar',
      data:{labels:a.values.map(v=>v.label||'—'), datasets:[{label:'Count', data:a.values.map(v=>v.count||0), backgroundColor:'rgba(220,53,69,0.7)'}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}
    });
    weakAreaCharts.push(chart);
    document.getElementById(a.actionId).textContent=a.action;
  });
}

// ── Reset ─────────────────────────────────────────────
function showNoSelection() {
  document.getElementById('company-header').style.display='none';
  document.getElementById('main-content').style.display='none';
  document.getElementById('no-selection-state').style.display='block';
  document.getElementById('loading-state').style.display='none';
  if(trendChart) trendChart.destroy();
  if(sentimentPieChart) sentimentPieChart.destroy();
  weakAreaCharts.forEach(c=>c.destroy());
}

// ── Initialize ─────────────────────────────────────────────
document.addEventListener('DOMContentLoaded',()=>{
  loadCompanies();
  document.getElementById('refresh-btn')?.addEventListener('click',async()=>{
    if(currentCompanyId>0 && !isFetching) await loadDashboardData(currentCompanyId,true);
  });
});
</script>
{% endblock %}
